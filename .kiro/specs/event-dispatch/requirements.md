# Requirements Document

| é …ç›® | å†…å®¹ |
|------|------|
| **Document Title** | event-dispatch è¦ä»¶å®šç¾©æ›¸ |
| **Version** | 0.2 (Draft) |
| **Date** | 2025-12-03 |
| **Parent Spec** | wintf-P0-event-system |
| **Author** | AI-DLC System |

---

## Introduction

æœ¬ä»•æ§˜æ›¸ã¯ wintf ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã«ãŠã‘ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆé…ä¿¡æ©Ÿæ§‹ã¨ECSçµ±åˆã®è¦ä»¶ã‚’å®šç¾©ã™ã‚‹ã€‚è¦ªä»•æ§˜ã€Œwintf-P0-event-systemã€ã® Requirement 7ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆé…ä¿¡æ©Ÿæ§‹ï¼‰ãŠã‚ˆã³ Requirement 8ï¼ˆECSçµ±åˆï¼‰ã‚’å®Ÿè£…å¯¾è±¡ã¨ã™ã‚‹ã€‚

### èƒŒæ™¯

wintf ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã¯ã€æ—¢å­˜ã® `mouse.rs` ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŠã‚ˆã³ `handlers.rs` ã«ãŠã„ã¦:
- Win32 ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ECSã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼ˆ`MouseState`ï¼‰ã«å¤‰æ›
- ãƒ’ãƒƒãƒˆãƒ†ã‚¹ãƒˆã«ã‚ˆã‚Šå¯¾è±¡ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’ç‰¹å®šã—ã€`MouseState` ã‚’ä»˜ä¸

ã“ã“ã¾ã§ã¯å®Ÿè£…æ¸ˆã¿ã§ã‚ã‚‹ã€‚æœ¬ä»•æ§˜ã§ã¯ã€ãã®å…ˆã®ã‚¤ãƒ™ãƒ³ãƒˆä¼æ’­æ©Ÿæ§‹ï¼ˆãƒãƒ–ãƒªãƒ³ã‚°/ã‚­ãƒ£ãƒ—ãƒãƒ£ï¼‰ãŠã‚ˆã³ãƒãƒ³ãƒ‰ãƒ©ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒã‚’å®Ÿç¾ã™ã‚‹ã€‚

### ã‚¹ã‚³ãƒ¼ãƒ—

**å«ã¾ã‚Œã‚‹ã‚‚ã®**:
- ã‚¤ãƒ™ãƒ³ãƒˆä¼æ’­æ©Ÿæ§‹ï¼ˆãƒãƒ–ãƒªãƒ³ã‚°: å­â†’è¦ªã€ã‚­ãƒ£ãƒ—ãƒãƒ£: è¦ªâ†’å­ï¼‰
- ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒã‚·ã‚¹ãƒ†ãƒ 
- ã‚¤ãƒ™ãƒ³ãƒˆé…ä¿¡åœæ­¢ï¼ˆãƒãƒ³ãƒ‰ãƒ©æˆ»ã‚Šå€¤ã«ã‚ˆã‚‹åˆ¶å¾¡ï¼‰
- æ—¢å­˜ECSã‚·ã‚¹ãƒ†ãƒ ï¼ˆ`window.rs`, `layout/`ï¼‰ã¨ã®çµ±åˆ
- ã‚¤ãƒ™ãƒ³ãƒˆå±¥æ­´ä¿æŒï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
- ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£å‰Šé™¤æ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è§£é™¤

**å«ã¾ã‚Œãªã„ã‚‚ã®**:
- ãƒ’ãƒƒãƒˆãƒ†ã‚¹ãƒˆãƒ­ã‚¸ãƒƒã‚¯ï¼ˆ`event-hit-test` ä»•æ§˜ã§å®Ÿè£…æ¸ˆã¿ï¼‰
- Win32ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸â†’MouseStateå¤‰æ›ï¼ˆ`event-mouse-basic` ä»•æ§˜ã§å®Ÿè£…æ¸ˆã¿ï¼‰
- ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰/ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆï¼ˆå°†æ¥ã®æ‹¡å¼µï¼‰

### è¦ªä»•æ§˜ã‹ã‚‰ã®è¦ä»¶ãƒãƒƒãƒ”ãƒ³ã‚°

æœ¬ä»•æ§˜ã¯ä»¥ä¸‹ã®è¦ªè¦ä»¶ã«å¯¾å¿œã™ã‚‹ï¼š
- **Requirement 7**: ã‚¤ãƒ™ãƒ³ãƒˆé…ä¿¡æ©Ÿæ§‹
- **Requirement 8**: ECSçµ±åˆ

### è¨­è¨ˆæ–¹é‡ï¼ˆè­°è«–çµæœï¼‰

| é …ç›® | æ±ºå®šå†…å®¹ |
|------|---------|
| **ãƒãƒ³ãƒ‰ãƒ©å‹** | `fn(&mut World, Entity, &EventContext) -> bool` |
| **æˆ»ã‚Šå€¤** | `true` = ãƒãƒ³ãƒ‰ãƒ«æ¸ˆã¿ï¼ˆä¼æ’­åœæ­¢ï¼‰ã€`false` = æœªå‡¦ç†ï¼ˆç¶šè¡Œï¼‰ |
| **çŠ¶æ…‹ç®¡ç†** | ãƒãƒ³ãƒ‰ãƒ©ã¯ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¬ã‚¹ã€çŠ¶æ…‹ã¯ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«åˆ†é›¢ï¼ˆECSåŸå‰‡ï¼‰ |
| **ä¼æ’­æ–¹å¼** | 2ãƒ‘ã‚¹æ–¹å¼ï¼ˆãƒãƒ³ãƒ‰ãƒ©åé›†â†’å®Ÿè¡Œï¼‰ã§ãƒ•ãƒ¬ãƒ¼ãƒ é…å»¶ãªã— |
| **ã‚·ã‚¹ãƒ†ãƒ ç¨®åˆ¥** | æ’ä»–ã‚·ã‚¹ãƒ†ãƒ ï¼ˆ`&mut World`ï¼‰â€” ã‚¤ãƒ™ãƒ³ãƒˆä¼æ’­ã®æ€§è³ªä¸Šå¿…é ˆ |
| **å„ªå…ˆåº¦** | ãƒãƒ–ãƒªãƒ³ã‚°ï¼ˆé«˜ï¼‰â†’ stopPropagationï¼ˆä¸­ï¼‰â†’ ã‚­ãƒ£ãƒ—ãƒãƒ£ï¼ˆä½ï¼‰ |

---

## Requirements

### Requirement 1: ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ–ãƒªãƒ³ã‚°ï¼ˆå­â†’è¦ªä¼æ’­ï¼‰

**Objective:** é–‹ç™ºè€…ã¨ã—ã¦ã€å­ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã§ç™ºç”Ÿã—ãŸã‚¤ãƒ™ãƒ³ãƒˆã‚’è¦ªã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã«ã‚‚ä¼æ’­ã•ã›ãŸã„ã€‚ãã‚Œã«ã‚ˆã‚Šéšå±¤æ§‹é€ ã‚’æŒã¤UIã§ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’ä¸€å…ƒåŒ–ã§ãã‚‹ã€‚

**Priority:** P0ï¼ˆMVPå¿…é ˆï¼‰

#### Acceptance Criteria

1. When ãƒ’ãƒƒãƒˆãƒ†ã‚¹ãƒˆã«ã‚ˆã‚Šå­ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãŒã‚¤ãƒ™ãƒ³ãƒˆå¯¾è±¡ã¨ã—ã¦ç‰¹å®šã•ã‚ŒãŸæ™‚, the Event System shall å­ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‹ã‚‰è¦ªã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã¸é †ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä¼æ’­ã™ã‚‹
2. The Event System shall ECSè¦ªå­é–¢ä¿‚ï¼ˆ`Parent`/`Children` ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼‰ã«åŸºã¥ã„ã¦ãƒãƒ–ãƒªãƒ³ã‚°çµŒè·¯ã‚’æ±ºå®šã™ã‚‹
3. When ãƒãƒ–ãƒªãƒ³ã‚°ä¸­ã«ãƒ«ãƒ¼ãƒˆã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã«åˆ°é”ã—ãŸæ™‚, the Event System shall ä¼æ’­ã‚’çµ‚äº†ã™ã‚‹
4. The Event System shall å„ä¼æ’­æ®µéšã§ã‚¤ãƒ™ãƒ³ãƒˆå¯¾è±¡ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’è­˜åˆ¥å¯èƒ½ã«ã™ã‚‹
5. While ãƒãƒ–ãƒªãƒ³ã‚°ä¸­, the Event System shall å…ƒã®ãƒ’ãƒƒãƒˆå¯¾è±¡ï¼ˆ`original_target`ï¼‰æƒ…å ±ã‚’ä¿æŒã™ã‚‹

---

### Requirement 2: ã‚¤ãƒ™ãƒ³ãƒˆã‚­ãƒ£ãƒ—ãƒãƒ£ï¼ˆè¦ªâ†’å­ä¼æ’­ï¼‰

**Objective:** é–‹ç™ºè€…ã¨ã—ã¦ã€è¦ªã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã§ã‚¤ãƒ™ãƒ³ãƒˆã‚’å…ˆã«å‡¦ç†ã—ã¦ã‹ã‚‰å­ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã«ä¼æ’­ã•ã›ãŸã„ã€‚ãã‚Œã«ã‚ˆã‚Šè¦ªã§ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‚å—ãƒ»åŠ å·¥ã§ãã‚‹ã€‚

**Priority:** P2ï¼ˆå°†æ¥å®Ÿè£…ï¼‰â€” ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ãƒã‚¹ã‚³ãƒƒãƒˆç”¨é€”ã§ã¯å³æ™‚å¿…è¦ãªã—

#### Acceptance Criteria

1. When ã‚­ãƒ£ãƒ—ãƒãƒ£ãƒ•ã‚§ãƒ¼ã‚ºãŒæœ‰åŠ¹ãªæ™‚, the Event System shall ãƒ«ãƒ¼ãƒˆã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‹ã‚‰ãƒ’ãƒƒãƒˆå¯¾è±¡ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã¸é †ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä¼æ’­ã™ã‚‹
2. The Event System shall ã‚­ãƒ£ãƒ—ãƒãƒ£ãƒ•ã‚§ãƒ¼ã‚ºã¨ãƒãƒ–ãƒªãƒ³ã‚°ãƒ•ã‚§ãƒ¼ã‚ºã‚’åŒºåˆ¥ã§ãã‚‹ãƒ•ã‚§ãƒ¼ã‚ºæƒ…å ±ï¼ˆ`Phase::Capture`ï¼‰ã‚’æä¾›ã™ã‚‹
3. The Event System shall ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ãƒãƒ–ãƒªãƒ³ã‚°ã®ã¿ã‚’æœ‰åŠ¹ã¨ã—ã€ã‚­ãƒ£ãƒ—ãƒãƒ£ã¯ã‚ªãƒ—ãƒˆã‚¤ãƒ³æ–¹å¼ã¨ã™ã‚‹
4. When ã‚­ãƒ£ãƒ—ãƒãƒ£ãƒãƒ³ãƒ‰ãƒ©ãŒç™»éŒ²ã•ã‚ŒãŸã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã«åˆ°é”ã—ãŸæ™‚, the Event System shall ã‚­ãƒ£ãƒ—ãƒãƒ£ãƒ•ã‚§ãƒ¼ã‚ºã§ãã®ãƒãƒ³ãƒ‰ãƒ©ã‚’å‘¼ã³å‡ºã™
5. The Event System shall ã‚­ãƒ£ãƒ—ãƒãƒ£ãƒ•ã‚§ãƒ¼ã‚ºå®Œäº†å¾Œã«ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ•ã‚§ãƒ¼ã‚ºã€ãã®å¾Œãƒãƒ–ãƒªãƒ³ã‚°ãƒ•ã‚§ãƒ¼ã‚ºã®é †ã§å‡¦ç†ã™ã‚‹

---

### Requirement 3: ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

**Objective:** é–‹ç™ºè€…ã¨ã—ã¦ã€ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã‚’ç™»éŒ²ã—ãŸã„ã€‚ãã‚Œã«ã‚ˆã‚Šã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆã”ã¨ã®ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ã‚’å®šç¾©ã§ãã‚‹ã€‚

**Priority:** P0ï¼ˆMVPå¿…é ˆï¼‰

#### Acceptance Criteria

1. The Event System shall `MouseEventHandler` ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’æä¾›ã™ã‚‹
2. The Event System shall ãƒãƒ³ãƒ‰ãƒ©ã¨ã—ã¦ `fn(&mut World, Entity, &EventContext) -> bool` å‹ã®é–¢æ•°ãƒã‚¤ãƒ³ã‚¿ã‚’å—ã‘ä»˜ã‘ã‚‹
3. When ãƒãƒ³ãƒ‰ãƒ©ãŒ `true` ã‚’è¿”ã—ãŸæ™‚, the Event System shall ä»¥é™ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã¸ã®ä¼æ’­ã‚’åœæ­¢ã™ã‚‹
4. When ãƒãƒ³ãƒ‰ãƒ©ãŒ `false` ã‚’è¿”ã—ãŸæ™‚, the Event System shall æ¬¡ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã¸ä¼æ’­ã‚’ç¶™ç¶šã™ã‚‹
5. The Event System shall ãƒãƒ³ãƒ‰ãƒ©å†…ã§ä»»æ„ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®èª­ã¿æ›¸ãã‚’å¯èƒ½ã«ã™ã‚‹ï¼ˆ`&mut World` çµŒç”±ï¼‰

---

### Requirement 4: ã‚¤ãƒ™ãƒ³ãƒˆã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ

**Objective:** é–‹ç™ºè€…ã¨ã—ã¦ã€ãƒãƒ³ãƒ‰ãƒ©å†…ã§ã‚¤ãƒ™ãƒ³ãƒˆã®è©³ç´°æƒ…å ±ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã„ã€‚ãã‚Œã«ã‚ˆã‚Šé©åˆ‡ãªå‡¦ç†åˆ¤æ–­ãŒã§ãã‚‹ã€‚

**Priority:** P0ï¼ˆMVPå¿…é ˆï¼‰

#### Acceptance Criteria

1. The Event System shall `EventContext` æ§‹é€ ä½“ã‚’æä¾›ã™ã‚‹
2. The Event System shall `EventContext` ã«å…ƒã®ãƒ’ãƒƒãƒˆå¯¾è±¡ï¼ˆ`original_target: Entity`ï¼‰ã‚’å«ã‚ã‚‹
3. The Event System shall `EventContext` ã«ãƒã‚¦ã‚¹çŠ¶æ…‹ï¼ˆ`mouse_state: MouseState`ï¼‰ã‚’å«ã‚ã‚‹
4. The Event System shall `EventContext` ã«ç¾åœ¨ã®ãƒ•ã‚§ãƒ¼ã‚ºï¼ˆ`phase: Phase`ï¼‰ã‚’å«ã‚ã‚‹
5. The Event System shall `Phase` åˆ—æŒ™å‹ã¨ã—ã¦ `Target`, `Bubble`, `Capture` ã‚’å®šç¾©ã™ã‚‹

---

### Requirement 5: ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒã‚·ã‚¹ãƒ†ãƒ 

**Objective:** é–‹ç™ºè€…ã¨ã—ã¦ã€ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒãŒè‡ªå‹•çš„ã«å®Ÿè¡Œã•ã‚Œã‚‹ã“ã¨ã‚’æœŸå¾…ã™ã‚‹ã€‚ãã‚Œã«ã‚ˆã‚Šæ‰‹å‹•ã§ã®ã‚¤ãƒ™ãƒ³ãƒˆé…ä¿¡ãŒä¸è¦ã«ãªã‚‹ã€‚

**Priority:** P0ï¼ˆMVPå¿…é ˆï¼‰

#### Acceptance Criteria

1. The Event System shall `dispatch_mouse_events` ã‚·ã‚¹ãƒ†ãƒ ã‚’æä¾›ã™ã‚‹
2. The Event System shall åŒä¸€ãƒ•ãƒ¬ãƒ¼ãƒ å†…ã§ãƒ‘ã‚¹åé›†ã¨ãƒãƒ³ãƒ‰ãƒ©å®Ÿè¡Œã‚’å®Œäº†ã™ã‚‹ï¼ˆãƒ•ãƒ¬ãƒ¼ãƒ é…å»¶ãªã—ï¼‰
3. The Event System shall æ’ä»–ã‚·ã‚¹ãƒ†ãƒ ï¼ˆ`&mut World`ï¼‰ã¨ã—ã¦å®Ÿè£…ã™ã‚‹
4. The Event System shall Input ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å†…ã§ã€`process_mouse_buffers` ã®å¾Œã«å®Ÿè¡Œã™ã‚‹
5. When `MouseEventHandler` ã‚’æŒãŸãªã„ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®å ´åˆ, the Event System shall ãã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦æ¬¡ã¸ä¼æ’­ã™ã‚‹

---

### Requirement 6: ECSã‚·ã‚¹ãƒ†ãƒ çµ±åˆ

**Objective:** é–‹ç™ºè€…ã¨ã—ã¦ã€ã‚¤ãƒ™ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ ã‚’bevy_ecsã®ã‚·ã‚¹ãƒ†ãƒ ã¨ã—ã¦çµ±åˆã—ãŸã„ã€‚ãã‚Œã«ã‚ˆã‚Šæ—¢å­˜ã®wintfã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¨ä¸€è²«æ€§ã‚’ä¿ã¦ã‚‹ã€‚

**Priority:** P0ï¼ˆMVPå¿…é ˆï¼‰

#### Acceptance Criteria

1. The Event System shall bevy_ecsã‚·ã‚¹ãƒ†ãƒ ã¨ã—ã¦å®Ÿè£…ã•ã‚Œã‚‹
2. The Event System shall æ—¢å­˜ã®ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚·ã‚¹ãƒ†ãƒ ï¼ˆ`window.rs`, `window_system.rs`ï¼‰ã¨çµ±åˆã•ã‚Œã‚‹
3. The Event System shall æ—¢å­˜ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚·ã‚¹ãƒ†ãƒ ï¼ˆ`layout/`ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼‰ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£éšå±¤ã‚’å‚ç…§ã™ã‚‹
4. The Event System shall é©åˆ‡ãªã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆInput â†’ Update â†’ Renderï¼‰ã§å®Ÿè¡Œã•ã‚Œã‚‹
5. When æ–°ã—ã„ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒä½œæˆã•ã‚ŒãŸæ™‚, the Event System shall è‡ªå‹•çš„ã«ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ã‚’é–‹å§‹ã™ã‚‹

---

### Requirement 7: ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£å‰Šé™¤æ™‚ã®è§£é™¤

**Objective:** é–‹ç™ºè€…ã¨ã—ã¦ã€ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£å‰Šé™¤æ™‚ã«é–¢é€£ã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆçŠ¶æ…‹ãŒè‡ªå‹•çš„ã«ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã•ã‚Œã‚‹ã“ã¨ã‚’ä¿è¨¼ã—ãŸã„ã€‚ãã‚Œã«ã‚ˆã‚Šãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ã‚„ãƒ€ãƒ³ã‚°ãƒªãƒ³ã‚°å‚ç…§ã‚’é˜²ã’ã‚‹ã€‚

**Priority:** P1ï¼ˆä½“é¨“å‘ä¸Šï¼‰

#### Acceptance Criteria

1. When ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãŒå‰Šé™¤ã•ã‚ŒãŸæ™‚, the Event System shall é–¢é€£ã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒƒãƒ•ã‚¡ï¼ˆ`MouseBuffer`, `ButtonBuffer`, `WheelBuffer`ï¼‰ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹
2. When ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãŒå‰Šé™¤ã•ã‚ŒãŸæ™‚, the Event System shall é€²è¡Œä¸­ã®ä¼æ’­çµŒè·¯ã‹ã‚‰ãã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’é™¤å¤–ã™ã‚‹
3. The Event System shall ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£å‰Šé™¤ã‚’æ¤œå‡ºã™ã‚‹ãŸã‚ã«bevy_ecsã® `RemovedComponents` ã‚’ä½¿ç”¨ã™ã‚‹
4. When è¦ªã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãŒå‰Šé™¤ã•ã‚ŒãŸæ™‚, the Event System shall å­ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã¸ã®å½±éŸ¿ã‚’é©åˆ‡ã«å‡¦ç†ã™ã‚‹
5. The Event System shall å‰Šé™¤ã•ã‚ŒãŸã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã¸ã®ã‚¤ãƒ™ãƒ³ãƒˆé…ä¿¡ã‚’è©¦ã¿ãªã„

---

### Requirement 8: ã‚¤ãƒ™ãƒ³ãƒˆå±¥æ­´ä¿æŒ

**Objective:** é–‹ç™ºè€…ã¨ã—ã¦ã€ãƒ‡ãƒãƒƒã‚°ç›®çš„ã§ã‚¤ãƒ™ãƒ³ãƒˆå±¥æ­´ã‚’å‚ç…§ã—ãŸã„ã€‚ãã‚Œã«ã‚ˆã‚Šå•é¡Œç™ºç”Ÿæ™‚ã®åŸå› èª¿æŸ»ãŒå®¹æ˜“ã«ãªã‚‹ã€‚

**Priority:** P2ï¼ˆé«˜åº¦æ©Ÿèƒ½ï¼‰

#### Acceptance Criteria

1. The Event System shall ç›´è¿‘ã®ã‚¤ãƒ™ãƒ³ãƒˆå±¥æ­´ã‚’ãƒªãƒ³ã‚°ãƒãƒƒãƒ•ã‚¡ã§ä¿æŒã™ã‚‹
2. The Event System shall æœ€å¤§1000ä»¶ã®ã‚¤ãƒ™ãƒ³ãƒˆå±¥æ­´ã‚’ä¿æŒã™ã‚‹
3. The Event System shall ã‚¤ãƒ™ãƒ³ãƒˆå±¥æ­´ã«ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã€ã‚¤ãƒ™ãƒ³ãƒˆç¨®åˆ¥ã€å¯¾è±¡ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã€ä¼æ’­çµŒè·¯ã‚’å«ã‚ã‚‹
4. The Event System shall ã‚¤ãƒ™ãƒ³ãƒˆå±¥æ­´ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹APIã‚’æä¾›ã™ã‚‹
5. Where ãƒ‡ãƒãƒƒã‚°ãƒ“ãƒ«ãƒ‰ã®å ´åˆ, the Event System shall è©³ç´°ãªã‚¤ãƒ™ãƒ³ãƒˆãƒˆãƒ¬ãƒ¼ã‚¹ãƒ­ã‚°ã‚’å‡ºåŠ›ã§ãã‚‹

---

## Non-Functional Requirements

### NFR-1: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹

- ã‚¤ãƒ™ãƒ³ãƒˆä¼æ’­: 1ã‚¤ãƒ™ãƒ³ãƒˆã‚ãŸã‚Š1msä»¥å†…ã§å®Œäº†ï¼ˆ10éšå±¤ã¾ã§ï¼‰
- ãƒ¡ãƒ¢ãƒª: ã‚¤ãƒ™ãƒ³ãƒˆå±¥æ­´ã¯ç›´è¿‘1000ä»¶ã¾ã§ã€åˆè¨ˆ1MBä»¥ä¸‹
- ãƒãƒƒãƒ•ã‚¡å‡¦ç†: 1ãƒ•ãƒ¬ãƒ¼ãƒ ã‚ãŸã‚Š16msä»¥å†…ã§å…¨ãƒãƒƒãƒ•ã‚¡å‡¦ç†å®Œäº†
- **ãƒ•ãƒ¬ãƒ¼ãƒ é…å»¶ãªã—**: ä¼æ’­ã¯åŒä¸€ãƒ•ãƒ¬ãƒ¼ãƒ å†…ã§å®Œçµã™ã‚‹ã“ã¨ï¼ˆå¿…é ˆï¼‰

### NFR-2: ä¿¡é ¼æ€§

- ã‚¤ãƒ™ãƒ³ãƒˆã®å–ã‚Šã“ã¼ã—ãªã—
- æ­£ç¢ºãªä¼æ’­é †åºï¼ˆã‚­ãƒ£ãƒ—ãƒãƒ£â†’ã‚¿ãƒ¼ã‚²ãƒƒãƒˆâ†’ãƒãƒ–ãƒªãƒ³ã‚°ï¼‰
- ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£å‰Šé™¤æ™‚ã®ãƒªã‚½ãƒ¼ã‚¹ãƒªãƒ¼ã‚¯é˜²æ­¢

### NFR-3: äº’æ›æ€§

- æ—¢å­˜ã® `MouseState` ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨ã®å¾Œæ–¹äº’æ›æ€§
- æ—¢å­˜ã®ãƒãƒƒãƒ•ã‚¡æ©Ÿæ§‹ï¼ˆ`MOUSE_BUFFERS`, `BUTTON_BUFFERS` ç­‰ï¼‰ã¨ã®çµ±åˆ

---

## Glossary

| ç”¨èª | èª¬æ˜ |
|------|------|
| ãƒãƒ–ãƒªãƒ³ã‚° | ã‚¤ãƒ™ãƒ³ãƒˆãŒå­ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‹ã‚‰è¦ªã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã¸ä¼æ’­ã™ã‚‹ä»•çµ„ã¿ |
| ã‚­ãƒ£ãƒ—ãƒãƒ£ | ã‚¤ãƒ™ãƒ³ãƒˆãŒè¦ªã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‹ã‚‰å­ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã¸ä¼æ’­ã™ã‚‹ä»•çµ„ã¿ |
| ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ•ã‚§ãƒ¼ã‚º | å®Ÿéš›ã«ãƒ’ãƒƒãƒˆã—ãŸã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã§ã‚¤ãƒ™ãƒ³ãƒˆãŒå‡¦ç†ã•ã‚Œã‚‹ãƒ•ã‚§ãƒ¼ã‚º |
| ãƒãƒ³ãƒ‰ãƒ© | ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‡¦ç†ã™ã‚‹é–¢æ•°ãƒã‚¤ãƒ³ã‚¿ |
| æ’ä»–ã‚·ã‚¹ãƒ†ãƒ  | `&mut World` ã‚’å–ã‚‹bevy_ecsã‚·ã‚¹ãƒ†ãƒ ã€‚ä»–ã‚·ã‚¹ãƒ†ãƒ ã¨ä¸¦åˆ—å®Ÿè¡Œä¸å¯ |

---

## Appendix

### A. é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- è¦ªä»•æ§˜: `.kiro/specs/wintf-P0-event-system/requirements.md`
- ã‚¤ãƒ™ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆ: `doc/spec/08-event-system.md`
- æ—¢å­˜ãƒã‚¦ã‚¹å®Ÿè£…: `crates/wintf/src/ecs/mouse.rs`

### B. ä»•æ§˜é–“ã®è²¬å‹™åˆ†æ‹…

| ä»•æ§˜ | è²¬å‹™ | çŠ¶æ…‹ |
|------|------|------|
| `event-mouse-basic` | Win32ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ â†’ MouseState ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆä»˜ä¸ | âœ… å®Ÿè£…æ¸ˆã¿ |
| `event-hit-test` | åº§æ¨™ â†’ ãƒ’ãƒƒãƒˆå¯¾è±¡ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ç‰¹å®š | âœ… å®Ÿè£…æ¸ˆã¿ |
| `event-dispatch` | MouseState â†’ ä¼æ’­ãƒ»ãƒãƒ³ãƒ‰ãƒ©å‘¼ã³å‡ºã— | ğŸ“ æœ¬ä»•æ§˜ |

### C. å‹å®šç¾©ï¼ˆè¨­è¨ˆæ¡ˆï¼‰

```rust
/// ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
#[derive(Component, Clone, Copy)]
pub struct MouseEventHandler {
    /// ãƒãƒ³ãƒ‰ãƒ©é–¢æ•°
    /// æˆ»ã‚Šå€¤: true = ãƒãƒ³ãƒ‰ãƒ«æ¸ˆã¿ï¼ˆä¼æ’­åœæ­¢ï¼‰ã€false = æœªå‡¦ç†ï¼ˆç¶šè¡Œï¼‰
    pub handler: fn(&mut World, Entity, &EventContext) -> bool,
}

/// ã‚¤ãƒ™ãƒ³ãƒˆã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
#[derive(Clone)]
pub struct EventContext {
    pub original_target: Entity,  // ãƒ’ãƒƒãƒˆå¯¾è±¡
    pub mouse_state: MouseState,  // ãƒã‚¦ã‚¹çŠ¶æ…‹
    pub phase: Phase,             // ç¾åœ¨ã®ãƒ•ã‚§ãƒ¼ã‚º
}

/// ã‚¤ãƒ™ãƒ³ãƒˆãƒ•ã‚§ãƒ¼ã‚º
#[derive(Clone, Copy, PartialEq, Eq, Debug)]
pub enum Phase {
    Capture,  // è¦ªâ†’å­ï¼ˆå°†æ¥å®Ÿè£…ï¼‰
    Target,   // ãƒ’ãƒƒãƒˆå¯¾è±¡
    Bubble,   // å­â†’è¦ª
}
```

### D. ã‚¤ãƒ™ãƒ³ãƒˆä¼æ’­ãƒ•ãƒ­ãƒ¼

```
Win32 Message (WM_*)
    â†“
handlers.rsï¼ˆå—ä¿¡ãƒ»ãƒãƒƒãƒ•ã‚¡è“„ç©ãƒ»MouseStateä»˜ä¸ï¼‰[event-mouse-basic]
    â†“
hit_testï¼ˆå¯¾è±¡ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ç‰¹å®šï¼‰[event-hit-test]
    â†“
dispatch_mouse_eventsï¼ˆä¼æ’­å‡¦ç†ï¼‰[event-dispatch - æœ¬ä»•æ§˜]
    â”‚
    â”œâ”€ Pass 1: ãƒãƒ³ãƒ‰ãƒ©åé›†ï¼ˆfnãƒã‚¤ãƒ³ã‚¿ã¯Copyï¼‰
    â”‚   path.iter().filter_map(|e| world.get::<MouseEventHandler>(e))
    â”‚
    â””â”€ Pass 2: ãƒãƒ³ãƒ‰ãƒ©å®Ÿè¡Œ
        for (entity, handler) in handlers {
            if handler(world, entity, &ctx) { break; }
        }
    â†“
Update Scheduleï¼ˆã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
    â†“
FrameFinalize Schedule - clear_transient_mouse_stateï¼ˆä¸€æ™‚çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆï¼‰
```
