# Implementation Plan

本タスクリストは `ukagaka-desktop-mascot` の設計に基づく実装タスクを定義する。

> **Note**: 本仕様は親仕様であり、多くの機能は子仕様（`areka-*`, `wintf-*`）で詳細化される。本タスクは子仕様の作成と、プラットフォームコア機能の実装に焦点を当てる。

---

## Phase 1: 子仕様書の作成

- [x] 1. 子仕様書の初期化と要件定義
- [x] 1.1 (P) wintf-image-widget 仕様書を作成する
  - WIC画像読み込み、D2D描画、透過PNG対応の要件定義
  - GIF/WebPアニメーション画像のフレーム抽出要件
  - タイマー駆動再生の要件
  - _Requirements: 1.1, 1.3, 2.4_

- [x] 1.2 (P) wintf-event-system 仕様書を作成する
  - ヒットテストシステムの要件定義
  - マウスイベント（クリック、ドラッグ、ホバー）配信の要件
  - キャラクターウィンドウのドラッグ移動要件
  - _Requirements: 5.1, 5.2, 5.3, 5.8_

- [x] 1.3 (P) wintf-typewriter 仕様書を作成する
  - 文字単位の表示制御要件
  - 現Labelからの拡張範囲定義
  - ウェイト制御の要件
  - _Requirements: 3.5, 4.7_

- [x] 1.4 (P) areka-reference-ghost 仕様書を作成する
  - MVP参照ゴーストの要件定義
  - 里々インスパイアDSLの基本構文定義
  - 2体キャラクター掛け合い会話の要件
  - MCP通信インターフェースの要件
  - _Requirements: 4.1, 4.2, 4.4, 4.5, 4.6, 26.1, 26.2, 26.3_

- [x] 1.5 (P) areka-reference-shell 仕様書を作成する
  - MVP参照シェルの要件定義
  - サーフェス画像仕様
  - アニメーション定義仕様
  - ヒット領域定義仕様
  - _Requirements: 2.2, 2.7, 8.1, 8.3, 27.10, 27.11, 27.12, 27.13_

- [x] 1.6 (P) areka-reference-balloon 仕様書を作成する
  - MVP参照バルーンの要件定義
  - スタイル定義仕様（フォント、色、背景）
  - 縦書き/横書き対応要件
  - _Requirements: 3.4, 3.6, 27.15, 27.16_

- [x] 1.7 (P) wintf-clickthrough 仕様書を作成する
  - 透過領域のクリックスルー（マウスイベント透過）
  - 不透明領域のヒット判定
  - WM_NCHITTESTハンドリング
  - レイヤードウィンドウとの統合
  - _Requirements: 1.6_

- [x] 1.8 (P) areka-window-placement 仕様書を作成する
  - キャラクターウィンドウの配置ルール
  - タスクバー張り付き、画面端配置
  - マルチモニター対応
  - 複数キャラクター間の相対位置管理
  - 配置の保存・復元
  - _Requirements: 1.4, 1.5, 1.7, 9.3, 16.6_

---

## Phase 2: wintf基盤拡張（子仕様に委譲）

> **Note**: 以下のタスクは子仕様書で詳細化される。ここではプレースホルダーとして記載。

- [ ] 2. wintf基盤機能の実装
- [ ] 2.1 wintf-image-widget を実装する
  - 子仕様 `wintf-image-widget` のタスクを実行
  - _Requirements: 1.1, 1.3, 2.4_

- [ ] 2.2 wintf-event-system を実装する
  - 子仕様 `wintf-event-system` のタスクを実行
  - _Requirements: 5.1, 5.2, 5.3, 5.8_

- [ ] 2.3 wintf-typewriter を実装する
  - 子仕様 `wintf-typewriter` のタスクを実行
  - _Requirements: 3.5_

---

## Phase 3: プラットフォームコア

- [ ] 3. パッケージマネージャの実装
- [ ] 3.1 マニフェスト解析機能を実装する
  - manifest.toml のパースとバリデーション
  - パッケージ種別（Brain/Shell/Balloon）の識別
  - バージョン情報と依存関係の解析
  - _Requirements: 27.5, 27.6, 27.7, 27.9, 27.19_

- [ ] 3.2 パッケージインストール機能を実装する
  - ローカルファイルからのインストール
  - URLからのダウンロードとインストール
  - パッケージディレクトリ構造の管理
  - _Requirements: 7.1, 7.2, 27.2, 27.22, 27.23_

- [ ] 3.3 パッケージロード機能を実装する
  - シェル素材（サーフェス、アニメーション定義）の読み込み
  - バルーンスタイルの読み込み
  - 頭脳パッケージ情報の取得
  - _Requirements: 7.1, 8.3, 27.10, 27.15_

- [ ] 3.4 アップデート保護機能を実装する
  - 保護対象フォルダ（save/等）の除外処理
  - .updateignore 形式の解析
  - アップデート時のファイル保護
  - _Requirements: 27.25, 27.26, 27.27_

---

- [ ] 4. MCP通信基盤の実装
- [ ] 4.1 MCPサーバー基盤を実装する
  - rmcp または独自JSON-RPC実装の選択と基盤構築
  - stdio/HTTP トランスポートの実装
  - JSON-RPC 2.0 メッセージハンドリング
  - _Requirements: 10.1, 10.4_

- [ ] 4.2 MCPツール（Tools）を実装する
  - display_text: バルーンテキスト表示
  - switch_surface: サーフェス切り替え
  - play_animation: アニメーション再生
  - get_variable / set_variable: 変数操作
  - _Requirements: 4.4, 2.2, 2.4_

- [ ] 4.3 MCPイベント通知を実装する
  - OnMouseClick, OnMouseMove: マウスイベント
  - OnTimer: タイマーイベント
  - OnBoot, OnClose: ライフサイクルイベント
  - _Requirements: 5.1, 6.7, 6.8_

- [ ] 4.4 ゴースト間通信機能を実装する
  - 起動中ゴースト一覧の提供（list_ghosts）
  - ゴースト間メッセージ送受信（send_message）
  - ゴーストプロフィール情報の公開
  - _Requirements: 10.1, 26.11, 26.12, 26.13, 26.14, 26.15_

---

- [ ] 5. スクリプトエンジンの実装
- [ ] 5.1 さくらスクリプト互換コマンド解析を実装する
  - MVPコマンドセット: 文字表示、\s[n]、\b[n]、\0/\1、\w[n]、\_w[n]、\n、\e
  - コマンドパーサーの実装
  - コマンド実行キューの管理
  - _Requirements: 4.1, 4.6, 4.7_

- [ ] 5.2 スクリプト実行エンジンを実装する
  - コマンド列の逐次実行
  - ウェイト処理（タイミング制御）
  - スコープ切り替え（2体キャラクター対応）
  - _Requirements: 4.6, 4.7_

- [ ] 5.3 変数管理システムを実装する
  - グローバル/ローカル変数の管理
  - 変数の永続化（ゴースト状態保存）
  - 変数参照・更新API
  - _Requirements: 4.4, 9.2_

---

- [ ] 6. 描画システムの実装
- [ ] 6.1 SurfaceRenderer を実装する
  - サーフェスIDから画像ロードとVisual割り当て
  - 透過PNG処理
  - サーフェス切り替え（トランジション効果）
  - _Requirements: 1.1, 1.3, 2.2, 2.3_

- [ ] 6.2 AnimationController を実装する
  - アニメーション定義（JSON/YAML）のパース
  - フレームタイミング管理
  - アイドルアニメーション自動再生
  - _Requirements: 2.1, 2.4, 2.5, 2.7_

- [ ] 6.3 BalloonRenderer を実装する
  - バルーンウィンドウ生成と配置
  - スキン（外観）適用
  - タイプライター表示連携
  - _Requirements: 3.1, 3.2, 3.3, 3.6_

---

- [ ] 7. イベントシステムの実装
- [ ] 7.1 HitTester を実装する
  - 座標からエンティティ特定
  - 領域（頭、胴体等）の識別
  - シェル定義からのヒット領域読み込み
  - _Requirements: 5.1, 5.2_

- [ ] 7.2 EventDispatcher を実装する
  - マウスイベントのキャプチャと配信
  - イベントからMCP通知への変換
  - イベント履歴の記録
  - _Requirements: 5.1, 5.3, 5.4, 5.5_

- [ ] 7.3 TimerSystem を実装する
  - システム時刻イベント（朝の挨拶等）
  - カスタムタイマーの管理
  - アイドル検出
  - _Requirements: 6.1, 6.7, 6.8_

---

## Phase 4: システム機能

- [ ] 8. 設定・永続化の実装
- [ ] 8.1 ConfigManager を実装する
  - アプリケーション設定の読み書き
  - 設定の即時反映
  - 設定エクスポート/インポート
  - _Requirements: 9.1, 9.4, 9.6_

- [ ] 8.2 StateStore を実装する
  - ゴースト状態（変数、記憶）の永続化
  - キャラクター表示位置の保存/復元
  - 定期的な自動保存
  - _Requirements: 9.2, 9.3, 30.6, 30.7, 30.8_

---

- [ ] 9. システムトレイ・常駐機能の実装
- [ ] 9.1 TrayIcon を実装する
  - システムトレイアイコン表示
  - トレイメニュー
  - 最小化時のトレイ格納
  - _Requirements: 13.1, 13.2, 13.3_

- [ ] 9.2 自動起動機能を実装する
  - Windows起動時の自動起動オプション
  - 終了確認ダイアログ
  - _Requirements: 13.4, 13.5_

---

- [ ] 10. エラーハンドリング・復旧の実装
- [ ] 10.1 クラッシュログ機能を実装する
  - 直近の会話ログ保存
  - イベント履歴保存
  - スタックトレース記録
  - _Requirements: 30.1, 30.2, 30.3, 30.4, 30.5_

- [ ] 10.2 状態復元機能を実装する
  - 前回の表示位置復元
  - 前回起動ゴーストの復元
  - エラー通知と継続動作
  - _Requirements: 30.6, 30.7, 30.9_

---

## Phase 5: 開発者支援（P1）

- [ ] 11. 開発者向け機能の実装
- [ ] 11.1 デバッグコンソールを実装する
  - リアルタイムログ表示
  - 変数インスペクタ
  - イベント履歴表示
  - _Requirements: 12.2, 28.1, 28.2, 28.3, 28.5_

- [ ] 11.2 ホットリロード機能を実装する
  - ファイル変更検知
  - スクリプト/シェルの再読み込み
  - _Requirements: 12.3, 28.4, 28.6_

- [ ] 11.3 テスト支援機能を実装する
  - サーフェスプレビュー
  - イベントシミュレーター
  - パッケージバリデーション
  - _Requirements: 12.4, 12.7, 28.8, 28.9, 28.20_

---

## Phase 6: 参照実装（子仕様に委譲）

- [ ] 12. 参照パッケージの実装
- [ ] 12.1 areka-reference-ghost を実装する
  - 子仕様 `areka-reference-ghost` のタスクを実行
  - _Requirements: 4.1, 4.2, 4.6, 26.1, 26.2_

- [ ] 12.2 areka-reference-shell を実装する
  - 子仕様 `areka-reference-shell` のタスクを実行
  - _Requirements: 2.2, 8.1, 27.10_

- [ ] 12.3 areka-reference-balloon を実装する
  - 子仕様 `areka-reference-balloon` のタスクを実行
  - _Requirements: 3.6, 27.15_

---

## Phase 7: 統合・検証

- [ ] 13. システム統合テスト
- [ ] 13.1 起動フロー統合テストを実施する
  - アプリ起動 → ゴースト表示 → 初期トーク表示
  - パッケージロードの検証
  - _Requirements: 1.1, 7.1, 7.3_

- [ ] 13.2 対話フロー統合テストを実施する
  - ユーザークリック → イベント発火 → ゴースト応答 → 表示
  - 2体キャラクター掛け合い会話
  - _Requirements: 4.6, 5.1, 26.1_

- [ ] 13.3 パフォーマンステストを実施する
  - アイドル時CPU使用率 < 1%
  - メモリ使用量 < 100MB
  - 60fps描画維持
  - _Requirements: 14.1, 14.2, 14.3_

---

## 延期タスク（MVP後）

以下のタスクはMVP後に実装予定：

### 選択肢・入力機能
- 選択肢UI（\q コマンド）
- テキスト入力ボックス
- _Requirements: 3.9, 3.10, 5.6, 5.7_

### クリックスルー
- 透過領域のクリックスルー（wintf-clickthrough）
- _Requirements: 1.6_

### Windows Animation API
- DirectComposition統合アニメーション（wintf-animation-api）
- _Requirements: 2.3, 2.6_

### 音声機能
- 音声合成連携
- 音声認識連携
- _Requirements: 19.1-19.8_

### LLM連携
- ローカルLLM統合
- クラウドAPI連携
- _Requirements: 4.8, 4.9, 4.10, 17.3, 17.5, 18.1-18.7_

### IDE連携
- DAP サーバー
- LSP サーバー
- _Requirements: 28.11-28.17_

### 高度な機能
- 画面認識
- ゴースト間LLM会話
- マルチデバイス同期
- _Requirements: 20.1-20.8, 23.1-23.6, 26.7-26.10, 26.16-26.20_

---

## 要件カバレッジ

| 要件グループ | 要件数 | MVPカバー | 延期 |
|-------------|--------|-----------|------|
| Req 1-2 (描画) | 15 | 12 | 3 |
| Req 3 (バルーン) | 10 | 8 | 2 |
| Req 4 (対話) | 10 | 7 | 3 |
| Req 5 (入力) | 8 | 5 | 3 |
| Req 6 (時間) | 8 | 4 | 4 |
| Req 7-8 (管理) | 12 | 12 | 0 |
| Req 9 (設定) | 6 | 6 | 0 |
| Req 10 (通信) | 5 | 4 | 1 |
| Req 11-16 (その他) | 多数 | 部分的 | 多数 |
| Req 17-26 (高度機能) | 多数 | 基本のみ | 多数 |
| Req 27 (パッケージ) | 27 | 24 | 3 |
| Req 28-31 (開発者/互換) | 多数 | 基本のみ | 多数 |

> **Note**: 本仕様は非常に広範な要件を含む。MVPでは「2体キャラクターが掛け合い会話できる」を目標とし、高度な機能（LLM、音声、画面認識等）は延期。
