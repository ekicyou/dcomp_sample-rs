# P0å®Ÿè£… å†é–‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹

## ç¾çŠ¶ã‚µãƒãƒªãƒ¼

**æ—¥æ™‚**: 2025-12-12  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: Phase 1ï¼ˆã‚¿ã‚¹ã‚¯1.1ã€œ1.3ï¼‰å†å®Ÿæ–½ãŒå¿…è¦

### èª¤ã£ãŸå‰æã®è¨‚æ­£

- âŒ **èª¤**: `comprehensive_control_flow_simple.pasta`ï¼ˆç°¡ç•¥ç‰ˆï¼‰ãŒP0å¯¾è±¡
- âœ… **æ­£**: `comprehensive_control_flow.pasta`ï¼ˆãƒ•ãƒ«æ©Ÿèƒ½ç‰ˆï¼‰ãŒP0å¯¾è±¡

### å®Ÿè£…æ¸ˆã¿æ©Ÿèƒ½ï¼ˆå†åˆ©ç”¨å¯èƒ½ï¼‰

âœ… **Phase 2-5: ãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ©ãƒ¼ã‚³ã‚¢æ©Ÿèƒ½**
- 2ãƒ‘ã‚¹ãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ©ãƒ¼ï¼ˆPass 1: ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ç”Ÿæˆã€Pass 2: mod pastaç”Ÿæˆï¼‰
- LabelRegistryï¼ˆãƒ©ãƒ™ãƒ«åé›†ãƒ»IDå‰²ã‚Šå½“ã¦ï¼‰
- ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ§‹é€ ç”Ÿæˆï¼ˆ`pub mod ãƒ©ãƒ™ãƒ«å_1 { pub fn __start__(ctx) {...} }`ï¼‰
- ãƒ­ãƒ¼ã‚«ãƒ«ãƒ©ãƒ™ãƒ«é–¢æ•°ç”Ÿæˆï¼ˆè¦ªãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å†…é…ç½®ï¼‰
- call/jumpæ–‡ç”Ÿæˆï¼ˆ`for a in pasta::call(...) { yield a; }`ï¼‰
- `mod pasta { fn jump/call/label_selector }`ç”Ÿæˆ
- å‹•çš„ã‚¢ã‚¯ã‚¿ãƒ¼æŠ½å‡ºï¼ˆ`use crate::{ã•ãã‚‰, ã†ã«ã‚…ã†};`ä½¿ç”¨ã™ã‚‹ã‚¢ã‚¯ã‚¿ãƒ¼ã®ã¿ï¼‰

âœ… **Phase 6: ã‚¨ãƒ³ã‚¸ãƒ³çµ±åˆï¼ˆéƒ¨åˆ†å®Œäº†ï¼‰**
- PastaEngine::new()ã§ã®2ãƒ‘ã‚¹ãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ«çµ±åˆ
- pasta_stdlib::select_label_to_id ã‚¹ã‚¿ãƒ–å®Ÿè£…ï¼ˆå¸¸ã«1ã‚’è¿”ã™ï¼‰

### æœªå®Ÿè£…æ©Ÿèƒ½ï¼ˆP0ç¯„å›²ï¼‰

âŒ **å˜èªå®šç¾©æ©Ÿèƒ½**
1. ãƒ‘ãƒ¼ã‚µãƒ¼æ‹¡å¼µ
   - ã‚°ãƒ­ãƒ¼ãƒãƒ«å˜èªå®šç¾©: `ï¼ æŒ¨æ‹¶ï¼šã“ã‚“ã«ã¡ã¯ã€€ã‚„ã‚ã€€ãƒãƒ­ãƒ¼`
   - ãƒ­ãƒ¼ã‚«ãƒ«å˜èªå®šç¾©: `ã€€ï¼ å ´æ‰€ï¼šæ±äº¬ã€€å¤§é˜ªã€€äº¬éƒ½`
   - å˜èªå±•é–‹: `ï¼ æŒ¨æ‹¶`ã€`ï¼ å ´æ‰€`ï¼ˆç™ºè¨€æ–‡ä¸­ï¼‰
   - å˜èªé–¢æ•°å‘¼ã³å‡ºã—: `ï¼ ãƒ­ãƒ¼ã‚«ãƒ«é–¢æ•°ï¼ˆã€Œã¯ã‚ãƒ¼ã€ï¼‰`

2. ãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ©ãƒ¼ç”Ÿæˆ
   - ã‚°ãƒ­ãƒ¼ãƒãƒ«å˜èª: ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å¤–ã§`pasta_stdlib::add_words("å˜èª", ["å€¤1", "å€¤2"])`
   - ãƒ­ãƒ¼ã‚«ãƒ«å˜èª: `ctx.pasta.add_words("å˜èª", ["å€¤1", "å€¤2"]); ctx.pasta.commit_words();`
   - å˜èªå±•é–‹: `for a in pasta::word(ctx, "å˜èª", []) { yield a; }`

3. ã‚¹ã‚¿ãƒ–å®Ÿè£…ï¼ˆP0ï¼‰
   - `pasta_stdlib::add_words()` - ä½•ã‚‚ã—ãªã„
   - `pasta_stdlib::word()` - æœ€åˆã®å€¤ã®ã¿è¿”ã™
   - å®Ÿéš›ã®å˜èªãƒ©ãƒ³ãƒ€ãƒ é¸æŠã¯P1å¯¾å¿œ

âŒ **ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«æ›´æ–°**
- `comprehensive_control_flow.expected.rn`ã®ç”Ÿæˆï¼ˆç¾åœ¨ã®å®Ÿè£…ã«åˆã‚ã›ãŸæœŸå¾…å‡ºåŠ›ï¼‰
- åŒ…æ‹¬çš„ãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ«ãƒ†ã‚¹ãƒˆä½œæˆ

### éƒ¨åˆ†å®Ÿè£…æ¸ˆã¿ï¼ˆç¶™ç¶šä½œæ¥­å¿…è¦ï¼‰

ğŸŸ¡ **ãƒ‘ãƒ¼ã‚µãƒ¼æ‹¡å¼µ**
- ASTæ‹¡å¼µå®Œäº†: `WordDef`, `PastaFile.global_words`, `LabelDef.local_words`
- Pestæ–‡æ³•è¿½åŠ å®Œäº†: `global_word_def`, `local_word_def`, `word_name`, `word_value_list`
- å…¨è§’ã‚³ãƒ¡ãƒ³ãƒˆå¯¾å¿œå®Œäº†: `ï¼ƒ`
- ãƒ‘ãƒ¼ã‚¹é–¢æ•°è¿½åŠ : `parse_word_def()` å®Ÿè£…æ¸ˆã¿
- âŒ ãƒ‘ãƒ¼ã‚¹å‹•ä½œç¢ºèªæœªå®Œäº†ï¼ˆãƒ‡ãƒãƒƒã‚°å¿…è¦ï¼‰

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆå„ªå…ˆé †ä½é †ï¼‰

### Step 1: ãƒ‘ãƒ¼ã‚µãƒ¼å®Œæˆï¼ˆå˜èªå®šç¾©ã®ãƒ‘ãƒ¼ã‚¹æˆåŠŸï¼‰

1. **ãƒ‘ãƒ¼ã‚¹ãƒ‡ãƒãƒƒã‚°**
   ```bash
   cargo test --package pasta --test test_parse_comprehensive -- --show-output
   ```
   - ã‚°ãƒ­ãƒ¼ãƒãƒ«å˜èªå®šç¾©ã®ãƒ‘ãƒ¼ã‚¹ç¢ºèª
   - ãƒ­ãƒ¼ã‚«ãƒ«å˜èªå®šç¾©ã®ãƒ‘ãƒ¼ã‚¹ç¢ºèªï¼ˆglobal_label/local_labelãƒ«ãƒ¼ãƒ«ã«çµ„ã¿è¾¼ã¿æ¸ˆã¿ï¼‰
   - ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç¢ºèªã—ã¦æ–‡æ³•ä¿®æ­£

2. **å˜èªå±•é–‹ãƒ‘ãƒ¼ã‚¹è¿½åŠ **
   - SpeechPart::WordExpansion ãƒãƒªã‚¢ãƒ³ãƒˆè¿½åŠ 
   - `@å˜èªå`ã®ãƒ‘ãƒ¼ã‚¹ãƒ«ãƒ¼ãƒ«è¿½åŠ 
   - `@å˜èªåï¼ˆå¼•æ•°ï¼‰`ã®ãƒ‘ãƒ¼ã‚¹ãƒ«ãƒ¼ãƒ«è¿½åŠ 

### Step 2: ãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ©ãƒ¼æ‹¡å¼µï¼ˆå˜èªå®šç¾©â†’Runeç”Ÿæˆï¼‰

1. **ã‚°ãƒ­ãƒ¼ãƒãƒ«å˜èªå®šç¾©ã®ç”Ÿæˆ**
   ```rune
   pasta_stdlib::add_words("æŒ¨æ‹¶", ["ã“ã‚“ã«ã¡ã¯", "ã‚„ã‚", "ãƒãƒ­ãƒ¼"]);
   ```
   - `transpile_pass1()`ã§`file.global_words`ã‚’å‡¦ç†
   - ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å®šç¾©ã®å‰ã«å‡ºåŠ›

2. **ãƒ­ãƒ¼ã‚«ãƒ«å˜èªå®šç¾©ã®ç”Ÿæˆ**
   ```rune
   pub fn __start__(ctx) {
       ctx.pasta.add_words("å ´æ‰€", ["æ±äº¬", "å¤§é˜ª", "äº¬éƒ½"]);
       ctx.pasta.commit_words();
       // ...
   }
   ```
   - `label.local_words`ã‚’å‡¦ç†
   - `__start__`é–¢æ•°ã®å…ˆé ­ã§å‡ºåŠ›

3. **å˜èªå±•é–‹ã®ç”Ÿæˆ**
   ```rune
   for a in pasta::word(ctx, "æŒ¨æ‹¶", []) { yield a; }
   ```
   - `SpeechPart::WordExpansion`ã‚’å‡¦ç†

### Step 3: expected.rnç”Ÿæˆ

1. **comprehensive_control_flow.pastaã‚’ãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ«**
   ```bash
   # æ‰‹å‹•ãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ«å®Ÿè¡Œ
   cargo run --package pasta --bin transpile_test
   ```
   
2. **å‡ºåŠ›ã‚’`comprehensive_control_flow.expected.rn`ã¨ã—ã¦ä¿å­˜**
   - å‹•çš„ã‚¢ã‚¯ã‚¿ãƒ¼æŠ½å‡ºã®ç¢ºèªï¼ˆ`use crate::{ã•ãã‚‰, ã†ã«ã‚…ã†};`ï¼‰
   - å˜èªå®šç¾©ç”Ÿæˆã®ç¢ºèª
   - ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ§‹é€ ã®ç¢ºèª

3. **æ‰‹å‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼**
   - è¦ä»¶5ã®å‡ºåŠ›ä»•æ§˜ã«æº–æ‹ ã—ã¦ã„ã‚‹ã‹ç¢ºèª
   - ä¸è¦ãªç©ºè¡Œãƒ»ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆä¿®æ­£

### Step 4: ãƒ†ã‚¹ãƒˆä½œæˆ

1. **test_comprehensive_control_flow.rsä½œæˆ**
   ```rust
   #[test]
   fn test_comprehensive_control_flow_transpile() {
       let pasta = fs::read_to_string("tests/fixtures/comprehensive_control_flow.pasta").unwrap();
       let expected = fs::read_to_string("tests/fixtures/comprehensive_control_flow.expected.rn").unwrap();
       
       let ast = parse_str(&pasta, "comprehensive_control_flow.pasta").unwrap();
       let transpiled = Transpiler::transpile_to_string(&ast).unwrap();
       
       assert_eq!(transpiled, expected, "ãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ«çµæœãŒæœŸå¾…å€¤ã¨ä¸€è‡´ã—ã¾ã›ã‚“");
   }
   ```

2. **Runeã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ç¢ºèªãƒ†ã‚¹ãƒˆ**
   ```rust
   #[test]
   fn test_comprehensive_control_flow_rune_compile() {
       // main.rnï¼ˆã‚¢ã‚¯ã‚¿ãƒ¼å®šç¾©ï¼‰ã‚’èª­ã¿è¾¼ã¿
       // comprehensive_control_flow.expected.rnã‚’èª­ã¿è¾¼ã¿
       // çµ±åˆã—ã¦Runeã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æˆåŠŸã‚’ç¢ºèª
   }
   ```

### Step 5: ã‚¹ã‚¿ãƒ–å®Ÿè£…ï¼ˆpasta_stdlibï¼‰

1. **add_words() ã‚¹ã‚¿ãƒ–**
   ```rune
   pub fn add_words(name, values) {
       // P0: ä½•ã‚‚ã—ãªã„
   }
   ```

2. **commit_words() ã‚¹ã‚¿ãƒ–**
   ```rune
   pub fn commit_words() {
       // P0: ä½•ã‚‚ã—ãªã„
   }
   ```

3. **word() ã‚¹ã‚¿ãƒ–**
   ```rune
   pub fn word(ctx, name, args) {
       yield name; // P0: å˜èªåã‚’ãã®ã¾ã¾è¿”ã™
   }
   ```

### Step 6: æœ€çµ‚æ¤œè¨¼

1. **å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ**
   ```bash
   cargo test --package pasta
   ```

2. **comprehensive_control_flowå®Ÿè¡Œãƒ†ã‚¹ãƒˆ**
   ```bash
   # ç„¡é™ãƒ«ãƒ¼ãƒ—å¯¾ç­–: yield 10å›ã§æ‰“ã¡åˆ‡ã‚Š
   cargo run --example run_comprehensive_control_flow
   ```

3. **P0 Validation Criteriaç¢ºèª**ï¼ˆtasks.mdæœ«å°¾å‚ç…§ï¼‰

## é‡è¦ãªæ³¨æ„äº‹é …

### comprehensive_control_flow.pastaã®ç‰¹å¾´

1. **Runeãƒ–ãƒ­ãƒƒã‚¯å†…ã®ãƒ­ãƒ¼ã‚«ãƒ«é–¢æ•°å®šç¾©**
   ```pasta
   ```rune
   pub fn ãƒ­ãƒ¼ã‚«ãƒ«é–¢æ•°(ctx, args) {
       let ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ = args[0];
       ctx.actor = super::ã†ã«ã‚…ã†;
       yield #{ type: "Actor", actor: ctx.actor };
       yield #{ type: "Talk", text: `ãƒ­ãƒ¼ã‚«ãƒ«é–¢æ•°ãŒå‘¼ã°ã‚Œã¾ã—ãŸ: ${ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸}` };
   }
   ```
   ```
   - ã“ã‚Œã¯**ãã®ã¾ã¾å‡ºåŠ›**ï¼ˆãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ«ä¸è¦ï¼‰
   - ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å†…ã«é…ç½®

2. **å‹•çš„call/jump**
   ```pasta
   ï¼ï¼ å¤‰æ•°å
   ```
   - P0ã§ã¯æœªå¯¾å¿œï¼ˆãƒ‘ãƒ¼ã‚¹æ™‚ã«ã‚¨ãƒ©ãƒ¼ï¼‰
   - P1å¯¾å¿œäºˆå®š

3. **ãƒ­ãƒ³ã‚°ã‚¸ãƒ£ãƒ³ãƒ—**
   ```pasta
   ï¼ï¼Šã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ¼ãƒ­ãƒ¼ã‚«ãƒ«
   ```
   - P0ã§å¯¾å¿œæ¸ˆã¿
   - æ¤œç´¢ã‚­ãƒ¼: `"ã‚°ãƒ­ãƒ¼ãƒãƒ«::ãƒ­ãƒ¼ã‚«ãƒ«"`å½¢å¼

## å‰Šé™¤ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆç°¡ç•¥ç‰ˆï¼‰

ä»¥ä¸‹ã¯èª¤ã£ãŸå‰æã§ä½œæˆã—ãŸãŸã‚å‰Šé™¤æ¸ˆã¿ï¼š

- âŒ `comprehensive_control_flow_simple.pasta`
- âŒ `comprehensive_control_flow_simple.expected.rn`
- âŒ `transpiler_comprehensive_test.rs`
- âŒ `test_comprehensive_execution.rs`

## åˆ©ç”¨å¯èƒ½ãªãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«

âœ… **test_dynamic_actors.rs** - å‹•çš„ã‚¢ã‚¯ã‚¿ãƒ¼æŠ½å‡ºã®ãƒ†ã‚¹ãƒˆï¼ˆ4ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹å…¨åˆæ ¼ï¼‰

## ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

```
crates/pasta/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ parser/
â”‚   â”‚   â”œâ”€â”€ mod.rs           # parse_word_def() å®Ÿè£…æ¸ˆã¿
â”‚   â”‚   â”œâ”€â”€ ast.rs           # WordDef å®šç¾©æ¸ˆã¿
â”‚   â”‚   â””â”€â”€ pasta.pest       # word_def ãƒ«ãƒ¼ãƒ«è¿½åŠ æ¸ˆã¿
â”‚   â”œâ”€â”€ transpiler/
â”‚   â”‚   â””â”€â”€ mod.rs           # å˜èªå®šç¾©ç”Ÿæˆã¯æœªå®Ÿè£…
â”‚   â””â”€â”€ engine.rs            # 2ãƒ‘ã‚¹ãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ«çµ±åˆæ¸ˆã¿
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ fixtures/
â”‚   â”‚   â”œâ”€â”€ comprehensive_control_flow.pasta      # âœ… æ­£ï¼ˆå…¥åŠ›ï¼‰
â”‚   â”‚   â””â”€â”€ comprehensive_control_flow.expected.rn # âŒ æœªä½œæˆï¼ˆå‡ºåŠ›ï¼‰
â”‚   â”œâ”€â”€ test_parse_comprehensive.rs   # ãƒ‘ãƒ¼ã‚¹ãƒ‡ãƒãƒƒã‚°ç”¨
â”‚   â””â”€â”€ test_dynamic_actors.rs        # å‹•çš„ã‚¢ã‚¯ã‚¿ãƒ¼æŠ½å‡ºãƒ†ã‚¹ãƒˆ
```

## æ¨å®šä½œæ¥­æ™‚é–“

- Step 1: ãƒ‘ãƒ¼ã‚µãƒ¼å®Œæˆ - 1ã€œ2æ™‚é–“
- Step 2: ãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ©ãƒ¼æ‹¡å¼µ - 2ã€œ3æ™‚é–“
- Step 3: expected.rnç”Ÿæˆ - 30åˆ†
- Step 4: ãƒ†ã‚¹ãƒˆä½œæˆ - 1æ™‚é–“
- Step 5: ã‚¹ã‚¿ãƒ–å®Ÿè£… - 30åˆ†
- Step 6: æœ€çµ‚æ¤œè¨¼ - 1æ™‚é–“

**åˆè¨ˆ**: 6ã€œ8æ™‚é–“
