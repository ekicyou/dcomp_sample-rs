# 古い命令型DSL構文 削除対象レポート

| 項目 | 内容 |
|------|------|
| **作成日時** | 2025-12-13 05:00 JST |
| **目的** | 元仕様に存在しない命令型構文の完全削除 |
| **ステータス** | 🔍 削除対象の特定完了、承認待ち |

---

## 背景

Pasta DSLは**宣言的言語**として設計されており、元仕様（areka-P0-script-engine）には命令型制御構文（`＠if`, `＠elif`, `＠else`, `＠while`）は含まれていません。

これらの構文は誤って追加されたもので、以下の問題を引き起こします：

1. **仕様との不一致**: 元仕様に存在しない機能
2. **設計思想の逸脱**: 宣言的言語に命令型構文が混在
3. **実装の混乱**: パーサーは既にサポートを削除しているが、ドキュメントには残存
4. **ユーザーの混乱**: 動作しない構文がドキュメントに記載

---

## 現状調査結果

### ✅ パーサー実装
**ステータス**: 命令型構文のサポートなし（既に削除済み）

- `crates/pasta/src/parser/pasta.pest`: 命令型構文の文法規則なし
- パーサーは命令型構文を**受け付けない**（正しい状態）

### ✅ テストコード
**ステータス**: 命令型構文を使用するテストなし

- `crates/pasta/tests/`: 命令型構文を含むテストファイルなし
- 全てのテストは宣言的構文のみを使用

### ⚠️ ドキュメント
**ステータス**: 命令型構文の説明が残存

#### ファイル: `crates/pasta/GRAMMAR.md`

**削除対象セクション**:

1. **行175-199: 条件分岐セクション**
   ```markdown
   ### 条件分岐
   
   #### if文
   
   ```pasta
   ＊条件判定
       ＠if：{score} > 50
           さくら：合格です！
       ＠else
           さくら：不合格です
   ```
   
   #### elif（else if）
   
   ```pasta
   ＊成績判定
       ＠if：{score} >= 90
           さくら：優秀！
       ＠elif：{score} >= 70
           さくら：良い！
       ＠elif：{score} >= 50
           さくら：合格
       ＠else
           さくら：不合格
   ```
   ```

2. **行201-211: whileループセクション**
   ```markdown
   ### ループ
   
   #### while ループ
   
   ```pasta
   ＊カウントダウン
       ＠count：10
       ＠while：{count} > 0
           さくら：残り{count}秒
           ＠count：{count} - 1
   ```
   ```

3. **行213-219: forループセクション**
   ```markdown
   #### for ループ
   
   ```pasta
   ＊リスト表示
       ＠for：i in range(5)
           さくら：カウント{i}
   ```
   ```

4. **行234-242: 条件付きジャンプセクション**
   ```markdown
   #### 条件付きジャンプ
   
   ```pasta
   ＊チェック
       ＠if：{ready}
           ＠jump：実行
       ＠else
           ＠jump：キャンセル
   ```
   ```

5. **行502-509: 変数セクション内の条件分岐例**
   ```markdown
   // 条件分岐
   ＊成績判定
       ＠if：{＊score} >= 100
           さくら：すごい！満点だ！
       ＠elif：{＊score} >= 50
           さくら：合格だね
       ＠else
           さくら：もう少し頑張ろう
   ```

### ⚠️ サンプルスクリプト
**ステータス**: 全体が命令型構文で記述

#### ファイル: `crates/pasta/examples/scripts/dic/04_control_flow.pasta`

**内容**: 全60行が命令型構文の例
- 条件分岐（`＠if`/`＠elif`/`＠else`）
- ループ（`＠while`/`＠for`）
- これらの構文はパーサーが受け付けないため、**このファイルは動作しない**

---

## 削除対象サマリー

| ファイル | 削除対象 | 影響 |
|---------|---------|------|
| `GRAMMAR.md` | 5セクション、約70行 | ドキュメントのみ |
| `04_control_flow.pasta` | ファイル全体（60行） | サンプルファイル |

**合計**: 約130行の削除

---

## 推奨される対応

### 1. GRAMMAR.mdの修正

**削除すべき内容**:
- 条件分岐セクション（if/elif/else）
- ループセクション（while/for）
- 条件付きジャンプの例

**追加すべき内容**:
- 宣言的コントロールフローの説明
  - Call文（`＞ラベル名`）
  - Jump文（`？ラベル名`）
  - ラベル定義（`＊グローバル`、`ーローカル`）
- Runeブロックでの条件分岐の説明（正しいアプローチ）
- `comprehensive_control_flow.pasta`への参照

### 2. 04_control_flow.pastaの処理

**オプション A: 削除**
- 動作しないファイルを削除
- `comprehensive_control_flow.pasta`が正しい参照実装として存在

**オプション B: 書き換え**（推奨しない、理由: P1機能が必要）
- 宣言的構文に完全書き換え
- ただし、ランダム選択等のP1機能が必要なため時期尚早

**推奨**: オプションAで削除、または「非推奨」コメントを追加して残す

---

## 検証計画

### 削除後の確認事項

1. **パーサーの動作確認**
   - 命令型構文を含むスクリプトがパースエラーになることを確認
   - 宣言的構文のみを含むスクリプトが正常にパースされることを確認

2. **ドキュメントの一貫性**
   - GRAMMAR.mdに命令型構文の説明が残っていないことを確認
   - 全ての例が動作する構文のみを使用していることを確認

3. **テストの実行**
   - 全テストが合格することを確認（核心機能テスト55+）
   - トランスパイルテストが成功することを確認

---

## 作業手順（承認後）

### Phase 1: ドキュメント修正
1. GRAMMAR.mdから命令型構文セクションを削除
2. 宣言的コントロールフローの説明を追加
3. comprehensive_control_flow.pastaへの参照を追加

### Phase 2: サンプルファイル処理
1. 04_control_flow.pastaを削除、または非推奨マークを追加
2. README等で正しいサンプルファイルを案内

### Phase 3: 検証
1. パーサーテストの実行
2. ドキュメントレビュー
3. 全テストスイートの実行

---

## リスク評価

| リスク | 可能性 | 影響 | 対策 |
|--------|--------|------|------|
| ユーザーが既存スクリプトで命令型構文を使用 | 低 | 中 | パーサーが既にサポートしていないため、影響は限定的 |
| ドキュメント不整合 | なし | なし | 今回の修正で解消 |
| テスト失敗 | なし | なし | テストは命令型構文を使用していない |

**総合評価**: **低リスク**
- パーサーが既にサポートしていない
- テストに影響なし
- ドキュメントの整合性向上

---

## 承認依頼

**削除対象**:
1. ✅ `GRAMMAR.md`: 命令型構文セクション（約70行）
2. ✅ `04_control_flow.pasta`: ファイル全体（60行）

**理由**:
- 元仕様に存在しない機能
- パーサーが既にサポートしていない（動作しない）
- ドキュメントと実装の不一致を解消

**代替**:
- `comprehensive_control_flow.pasta`: 正しい宣言的コントロールフローの参照実装
- 更新されたGRAMMAR.md: 宣言的構文の説明

---

**承認をお願いします。承認後、Phase 1-3の作業を実施します。**

---

**作成日時**: 2025-12-13 05:00 JST  
**ステータス**: 🔍 承認待ち  
**次のアクション**: ユーザー承認後、削除作業を実施
