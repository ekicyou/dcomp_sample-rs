# AIに与える指示など

## pastaエンジンの独立性
/kiro-spec-init
pastaエンジンは複数同時に初期化して同時に実行しても、それぞれ独立して動作するか。関連するテストは整備されているか。

仕様名は「pasta-」で始めよ。

## pasta:ローダーの確認
/kiro-spec-init
pastaエンジンは初期化時にスクリプトディレクトリの絶対・相対パスを与える仕様になっているか。スクリプトパスからの相対パスでDSLやruneファイルの配置ルールに従い、DSL/runeファイルを読み込んで起動準備完了するか。DSL/スクリプト配置ルールは定まっているか。テスト用のスクリプトディレクトリは存在するか。関連するテストは整備されているか。

仕様名は「pasta-」で始めよ。

## シリアライズ（永続化）ファイルの置き場所
/kiro-spec-init
pastaエンジンは初期化時にシリアライズディレクトリの絶対・相対パスを与える仕様になっているか。エンジンが把握する永続化データをシリアライズパスから読み込むか。テスト用の永続化ファイルディレクトリは存在するか。テスト用永続化ディレクトリの内容はテストコードが書き換えないように、テスト時に作成されるテンポラリディレクトリ（tempfileクレートを導入するとよい）に展開されるか。エンジンはdrop時にシリアライズパスに永続化データを保存するか。関連するテストは整備されているか。

仕様名は「pasta-」で始めよ。

## pasta:ローカルrule blockの呼び出しテスト
/kiro-spec-init
pasta DSL内のrune blockは、該当するDSLブロック内の「ローカル関数」として呼び出せるか？関連するテストは整備されているか。呼び出しのユニットテストを実装し、実装が正しいことを確認せよ。

- DSL会話行から「＠関数」「＠関数（引数）」で呼び出せること
- DSL CALL行から呼び出せること
- ローカル関数の第一引数にキャラクター構造体が渡されること

仕様名は「pasta-」で始めよ。

## pasta:jumpからの関数呼び出し
/kiro-spec-init
pasta DSL内のjumpブロックから呼び出せるのはラベルだけか？関数も含まれるか？jumpからの関数呼び出しを禁止すべきかどうか、要件を再検討せよ。
仕様名は「pasta-」で始めよ。

## pasta:直前のラベルの引継ぎ
/kiro-spec-init
pasta DSLで、「＊」と、「＊」の後にラベル名がない場合は、そのDSL内で最後に利用されたラベル名を継続利用してほしい。なお、DSLファイル内で最初に「＊」が使われた場合はラベル名が分からないためエラーとしてほしい。
仕様名は「pasta-」で始めよ。


## pasta:単語登録のためのDSL
/kiro-spec-init
pasta DSLで、現在、「＊挨拶」など、会話ブロックについては問題なく記載できるが、単語定義を行いたい場合に冗長である。単語定義のためのDSLを新たに要件定義し、実装に加えよ。単語定義について、会話内の「＠単語」などから呼び出せるようにせよ。グローバルセクションにも、ローカルセクションにも書けるようにせよ。

案：
```pasta
＃インデント無しの場合はグローバルブロック
＄場所：東京　ニューヨーク　千葉
＄場所：カナダ　オランダ　いつか見た場所

＃インデントがある場合はローカルブロック
＊会話
　＄天気：晴れ　雨　曇り　「晴れか、　あめ」
```

エンジン内のデータの持ち方は要検討。会話ブロックと同じで「単語」をひとつ返すだけの会話ブロックとするか、独立した辞書とするか。要件としては下記の通り
- call/jumpからは呼び出せなくてよい。
- 「＠会話」などの会話行からは呼び出せるべき。
- 会話行（＠会話）から、会話ラベルを呼び出せる必要はない。

仕様名は「pasta-」で始めよ。

## pasta:＠会話から呼び出される単語・関数のスコープ
/kiro-spec-init
pastaエンジンにおいて、会話行の「＠会話」から呼び出される要素について、以下の優先順位で決定してほしい。

1. ローカル関数（名称完全一致）
2. グローバル関数（名称完全一致）
3. ローカルとグローバルの単語辞書より、名称が前方一致するキーの全要素から一覧を作りシャッフル、１つずつ取り出す。同じ検索キーの検索結果はキャッシュして要素が残っていればpullしていく。

仕様名は「pasta-」で始めよ。

## pasta:会話の継続行扱い
/kiro-spec-init
pastaエンジンにおいて、現在、会話継続行で、インデントではなく、名前を指定しない「：」が利用されている。これは当初要件定義から変更された仕様である。「：」の省略可能性について検討し、必要なら仕様を変更せよ。

現在）
```pasta
    さくら：こんにちは！
    ：元気にしてた？
```

当初要件）
```pasta
    さくら：こんにちは！
            元気にしてた？
```
仕様名は「pasta-」で始めよ。





## ログの問題点
- `deferred_surface_creation_system`が動いている形跡がない。

## ログ
```log

```

## 確認
