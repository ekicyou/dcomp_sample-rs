# このドキュメントは参考にしないように

## pasta XXXX
/kiro-spec-init
pastaエンジンに関する仕様。会話行中のインライン要素「＠会話」について。たとえば「＠＠会話」となっているとき、
1. 最初の「＠会話」の単語解決
2. 解決した単語をキーワードにして単語解決
の、２段構えの検索になってほしい。理論上は＠＠＠などの３段構え以上も可能と考えて仕様を検討。

## pasta XXXX
/kiro-spec-init
pastaエンジンに関する仕様。チェイントーク（いったん会話を終了して次のトークに移る）ためのIRは定義されているか。例えば「＠チェイン」または「＞チェイン」などとして関数を呼び出して、チェイントーク挿入が実現可能か。なお、すでに実現可能だと要件定義作成時調査で確認できた場合、本仕様は確認のみでクローズとする。要件定義指示の時に調査せよ。



## 確認

## 定型句
要件定義から不明瞭な点をTODOでリストアップし、議題を1つずつディスカッション進行して。議題がクローズしたら文書更新してコミット、次の議題へ。

分析結果の指摘点や不明瞭な点・決定が必要な点をTODO抽出。
また、要件定義の「#### 出力例（リファレンス実装）」や「#### Acceptance Criteria」が、設計を詰めた結果食い違いが出ている。これらについては現在の設計が正だと考えられるため、要件定義の調整を含めてこれらも議題TODOに含めよ。
自明な修正については議論を行わずに修正クローズ、開発者確認が必要な項目は1つずつディスカッション進行して。議題がクリアになったら文書更新してコミット、次の議題へ。議題クリアの判断は都度行って自律的に進めるように。



## セレクターAPI

### Call/Jump行の変換

```pasta
  ？天気予報
```

```rune
  for a in pasta::jump(ctx, label, #{}, []) { yield a; }
```

### 利用方法(ctx.pasta API)

```rune
pub mod pasta{
  // Jump関数。Callとやることは同じ。callだけの実装でも可。
  pub fn pasta::jump(ctx, label, filters, args){
    let label = pasta::label_selector(label, filters)
    for a in label(ctx, args) { yield a; }
  }

  // rust側で登録するrune関数。ラベルから関数ポインタを返す。
  // global_label: string　      ⇒ グローバルラベル検索キー
  // local_label: Option<string> ⇒ ローカルラベル検索キー
  pub fn label_selector(label){
    let n = select_label_to_id(label, filters);
    match n {
        1 => crate::会話_1::__start__;
        2 => crate::会話_1::選択肢_1;
        3 => crate::会話_1::選択肢_2;
    }
  }

  // rust側で実装するrust関数。ラベルとfiltersから関数番号を返す。
  pub fn select_label_to_id(label, filters){
    1   // 現在は常に1を返す。
  }
}
```

### 実現したい検索方法

#### グローバルジャンプの場合
- **label_selector("会話",None)**
⇒ "会話" で始まるラベルを前方一致
⇒末尾が必ず`::__start__`であること。

#### ローカルジャンプの場合
-- **label_selector("会話_1::選択肢", None)**
⇒ `mod 会話_1`の要素から、"選択肢"で始まるラベルを前方一致

### filtersについて
API引数として予約。将来的にはフィルター条件をここに並べる。現在は無視してよいが、パラメーターとしては宣言してほしい。


## LabelRegistry でグローバル、ローカルを統一的に連番管理する方法

### グローバルの連番

("グローバルラベル名", "__start__")でキー

### ローカルの連番
("グローバルラベル名", "ローカルラベル名") でキー

### 同じグローバルラベルが複数あるが？
連番が重複しないことさえ保証すればよいので、実用上は困らない。fn_pathが少し長くなる弊害は発生するがそれだけといえばそれだけ。


