# Requirements Document

| 項目 | 内容 |
|------|------|
| **Document Title** | areka スクリプトエンジン 要件定義書 |
| **Version** | 1.0 |
| **Date** | 2025-11-29 |
| **Parent Spec** | ukagaka-desktop-mascot |
| **Priority** | P0 (MVP必須) |

---

## Introduction

本仕様書は areka アプリケーションにおけるスクリプトエンジンの要件を定義する。キャラクターとの自然な会話を実現し、人格と魅力を表現することを目的とする。

### 親仕様からのトレーサビリティ

本仕様は `ukagaka-desktop-mascot` の以下の要件をカバーする：

| 親要件ID | 内容 |
|----------|------|
| 4.1 | 里々にインスパイアされた対話記述DSLを解釈・実行できる |
| 4.3 | ユーザーがキャラクターをダブルクリックした時、対話イベントを発火する |
| 4.4 | 変数を保持し、スクリプト内で参照・更新できる |
| 4.5 | 条件分岐・ループ等の制御構文をサポートする |
| 4.6 | 複数キャラクター間での会話（掛け合い、漫才的やりとり）をスクリプトで記述できる |
| 4.7 | 発言者の切り替え、割り込み、同時発言などの会話制御ができる |
| 29.6 | さくらスクリプトの基本コマンドを出力できる |
| 29.7 | 独自拡張コマンドを定義できる |
| 29.8 | スクリプト出力とMCPコマンドを組み合わせられる |

### スコープ

**含まれるもの:**
- 対話記述DSL（里々インスパイア）のパーサーと実行エンジン
- **スクリプト言語の設計**（コマンド構文、ウェイト記法等）
- **中間表現（IR）の出力**（wintf-P0-typewriter への入力形式）
- さくらスクリプト互換コマンドの出力
- 変数管理（グローバル/ローカル）
- 制御構文（条件分岐、ループ、関数）
- 複数キャラクター会話制御

**含まれないもの:**
- LLM連携（areka-P2-llm-integration の責務）
- ゴーストパッケージ管理（areka-P0-package-manager の責務）
- タイプライター表示アニメーション（wintf-P0-typewriter の責務）

---

## DSL Syntax Specification

### 設計方針

本DSLは以下の方針で設計される：

1. **IME最適化**: JISキーボードでのIMEローマ字入力を前提とし、頻出構文はワンキー入力可能な全角記号を使用
2. **里々互換**: 基本構造は里々の辞書形式を踏襲
3. **Ren'Py模倣**: ラベル・call・jumpの概念はRen'Pyを参考
4. **Rust互換識別子**: ラベル名・変数名はRustの識別子規則に準拠（Unicode対応）
5. **Runeトランスコンパイル**: DSLはRuneスクリプトに変換されて実行される

### アーキテクチャ

```
┌─────────────┐
│ DSL Script  │  会話記述特化（シンプルな構文）
└──────┬──────┘
       │ トランスコンパイル
       ↓
┌─────────────┐
│ Rune Script │  汎用スクリプト実行エンジン
└──────┬──────┘
       │ 実行
       ↓
┌─────────────┐
│     IR      │  中間表現（Typewriterへ）
└─────────────┘
```

**責務分担**:
- **DSL**: 会話フロー制御（ラベル、ジャンプ、発言、ウェイト）に特化
- **Rune**: 複雑なロジック（演算、関数、MCP連携）を担当
- **トランスコンパイラ**: DSL構文をRuneコードに変換

### 基本構文

#### ラベル定義

**グローバルラベル**（ファイル全体スコープ）:
```
＊ラベル名
  処理内容...
```
- **記号**: `＊` (全角アスタリスク、Shift + `:` キー)
- **位置**: 行頭（インデントなし）
- **命名規則**: Rust識別子規則（Unicode XID_Start + XID_Continue）

**ローカルラベル**（グローバルラベル内スコープ）:
```
＊親ラベル
  処理...
  ーローカル名
    ローカル処理...
```
- **記号**: `ー` (全角ハイフン、`-` キー、ワンキー)
- **位置**: インデント + 行頭
- **スコープ**: 直前のグローバルラベル内でのみ有効

#### 制御フロー

**call**（サブルーチン呼び出し、戻り先を記憶）:
```
＞ローカル名           # ローカルcall（現在のグローバルラベル内）
＞＊グローバル名       # グローバルcall（ファイル全体）
＞＊グローバルーローカル # ロングジャンプcall（グローバル配下のローカル）
＞＠変数名             # 動的call（変数の値をラベル名として解決）
```
- **記号**: `＞` (全角右角括弧、Shift + `.` キー)
- **動作**: 指定ラベルを実行後、呼び出し元に戻る
- **デフォルト**: ローカルスコープ（安全性優先）

**jump**（無条件ジャンプ、戻らない）:
```
？ローカル名           # ローカルjump（現在のグローバルラベル内）
？＊グローバル名       # グローバルjump（ファイル全体）
？＊グローバルーローカル # ロングジャンプ（グローバル配下のローカル）
？＠変数名             # 動的jump（変数の値をラベル名として解決）
```
- **記号**: `？` (全角疑問符、Shift + `/` キー)
- **動作**: 指定ラベルにジャンプし、呼び出し元には戻らない
- **デフォルト**: ローカルスコープ（安全性優先）

#### ランダム選択とラベル解決

**同一ラベル名の複数定義**:

DSLは同一名のラベルを複数定義できる（里々互換）。

```
＊挨拶
  さくら：おはよう！

＊挨拶
  さくら：こんにちは！

＊挨拶
  さくら：こんばんは！
```

**内部処理**:
- エンジンは自動的に連番を付与: `挨拶_1`, `挨拶_2`, `挨拶_3`
- 作者は意識する必要なし

**前方一致ランダム選択**:

call/jumpは前方一致するすべてのラベルから1つをランダム選択する。

```
？＊挨拶              # 「挨拶」で始まるすべてのグローバルラベル
？＊挨拶ー朝          # 「挨拶」グローバル配下の「朝」ローカルラベル
```

**ロングジャンプの解決（フラット化方式）**:

```
？＊挨拶ー朝
```

1. 前方一致でグローバルとローカルの組み合わせをすべて列挙:
   - `挨拶_1ー朝_1`
   - `挨拶_1ー朝_2`
   - `挨拶_2ー朝_1`
   - `挨拶イベントー朝`
2. フラットリストとして扱い、1つをランダム選択
3. 選択されたラベルにジャンプ

**選択肢キャッシュ**:

エンジンは選択キーワード（例: `＊挨拶ー朝`）ごとにキャッシュを保持する。

**キャッシュ動作**:
1. 初回呼び出し時:
   - 前方一致でフラットリストを構築
   - リストをシャッフル
   - キャッシュに保存
2. 2回目以降:
   - キャッシュからリストを取得
   - 先頭要素を消費（未消化順に使用）
3. リスト消費完了:
   - キャッシュをクリア
   - 次回は再構築（全候補が再び利用可能）

**利点**:
- 会話バリエーションを順に消化
- 重複を避けつつ、全候補を均等に使用
- 里々の辞書エントリ的な挙動

#### 変数と関数呼び出し

**式展開**（統一構文）:
```
＠識別子
＠識別子（引数）
```

**基本動作**:
- **記号**: `＠` (全角アットマーク、`@` キー、ワンキー)
- **評価**: Rune変数または関数呼び出しとして評価
- **展開**: 戻り値の文字列をその場に埋め込む
- **出力**: IR形式のトークン列に変換

**使用例**:
```
さくら：今日は＠場所　に行こう。          # 変数参照
さくら：こんにちは＠W（300）お元気？     # 関数呼び出し（ウェイト生成）
さくら：今は＠現在時刻　です。           # システム関数
さくら：＠ランダム挨拶                   # ランダム選択関数
```

**変数代入・演算**:
- DSLでは簡易的な代入のみサポート（構文TBD）
- 複雑なロジックはRuneスクリプトブロックで記述

#### ウェイトとタイミング制御

**ウェイトシステム**:

DSLは自動的にテキストにウェイトを挿入し、自然なタイピング表現を実現する。

**ウェイト種別**（キャラクター毎のシステムパラメーター）:
1. **通常ウェイト**: 通常の文字間隔
2. **濁点ウェイト**: 濁点（゛）で終わる文字の後
3. **半濁点ウェイト**: 半濁点（゜）で終わる文字の後
4. **点々ウェイト**: `‥`, `…` 等の連続記号1文字毎

**明示的ウェイト挿入**:
```
さくら：こんにちは＠W（300）お元気ですか？
```
- `＠W（ミリ秒）`: 指定時間のウェイトをIRトークンとして挿入
- 関数呼び出しの一種として実装（IRウェイトトークンを返す）

**禁則処理**:

DSLは自動的に日本語禁則処理を行い、適切な位置にウェイトを挿入する。

**禁則文字定義**:
- **行頭禁則**: `、。，．・？！゛゜ヽヾゝゞ々ー）］｝」』!),.:;?]}｡｣､･ｰﾞﾟ`
- **行末禁則**: `（［｛「『([{｢`
- **ぶらさげ**: `、。，．,.`

**ウェイト挿入ルール**:
1. **基本**: 文字毎に通常ウェイトを挿入
2. **禁則文字**: 行頭禁則・ぶらさげ文字が続く間は通常ウェイトで連続処理
3. **区切り位置**: 禁則文字列の終端で濁点/半濁点ウェイトを挿入
   - 直前の文字が濁点 → 濁点ウェイト
   - 直前の文字が半濁点 → 半濁点ウェイト
   - それ以外 → 通常ウェイト
4. **点々記号**: `‥`, `…` の各文字に点々ウェイトを挿入

**処理例**:
```
入力: 「こんにちは、元気？」
出力: 「こ」[通常W]「ん」[通常W]「に」[通常W]「ち」[通常W]「は」[通常W]「、」[通常W]「元」[通常W]「気」[通常W]「？」[通常W]

入力: 「がんばって‥‥ね」
出力: 「が」[濁点W]「ん」[通常W]「ば」[濁点W]「っ」[通常W]「て」[通常W]「‥」[点々W]「‥」[点々W]「ね」[通常W]
```

**さくらスクリプトエスケープ**:

DSLはさくらスクリプトコマンド自体を解釈しないが、エスケープ処理は透過的に行う。

```
さくら：こんにちは\n今日はいい天気だね
```
- `\n`, `\w[n]`, `\s[n]` 等はそのままテキストトークンとして出力
- IR層またはTypewriter層で解釈
- **互換性**: SHIORI.DLL形式への転用が可能

#### 発言

**発言者指定**:
```
<空白><発言者名><空白>：<発言内容>
```

**構文規則**:
- **発言者名**: Unicode空白と `：` 以外のすべての文字
  - ひらがな、カタカナ、漢字、ASCII、数値、絵文字等すべて可
  - 例: `さくら`, `うにゅう`, `０`, `ナレーション`, `🌸`
- **コロン前の空白**: 見た目を揃えるため空白を許容
- **インデント**: Unicode空白カテゴリすべて（全角・半角混在可）

**複数行発言**（継続行）:
```
　さくら　：こんにちは。
　　　　　　今日はいい天気だね。
　　　　　　どこか行こうよ。
　うにゅう：せやね。
```
- **継続条件**: コロンなし + インデント増加
- **終了条件**: インデント減少 or 新しい発言者

**パーサー処理**:
1. 行に `：` が含まれる → 新しい発言開始
   - コロン前（空白除去後）= 発言者名
   - コロン後 = 発言内容
2. 行に `：` がなく、インデント増加 → 前の発言に継続
3. インデント減少 → 発言終了、次の処理へ

#### 使用例

```
＊初期化
  場所：ニューヨーク
  次の行動：会話
  
＊メインメニュー
  ナレーション：どうする？
  ？＠次の行動        # 動的ジャンプ（変数の値で分岐）

＊挨拶
  さくら    ：おはよう！

＊挨拶
  さくら    ：こんにちは！

＊挨拶イベント
  ー朝
    さくら    ：おはようございます。
                今日もがんばろうね！
    うにゅう  ：おはよう。
  ー朝
    さくら    ：朝だよ！起きて！
  ー夜
    さくら    ：こんばんは。
    うにゅう  ：おやすみ。

＊会話
  さくら    ：今日は＠場所　に行こう！
  うにゅう  ：いいね！
  ＞＊挨拶           # ランダムcall（挨拶, 挨拶, 挨拶イベントから1つ）
  ＞＊挨拶ー朝       # ロングジャンプcall（挨拶イベントー朝_1, 挨拶イベントー朝_2から1つ）
  さくら    ：楽しかったね。
  ？＊終了           # グローバルjump

＊別れ
  さくら    ：またね！
  うにゅう  ：ばいばい。

＊終了
  ナレーション：さようなら。
```

---

## Requirements

### Requirement 1: 対話記述DSL

**Objective:** ゴースト制作者として、自然な会話を簡潔に記述したい。それにより効率的にゴーストを制作できる。

#### Acceptance Criteria

1. **The** Script Engine **shall** 里々にインスパイアされた対話記述DSLを解釈・実行できる
2. **The** Script Engine **shall** トーク（発言ブロック）を定義できる
3. **The** Script Engine **shall** トーク内でテキストと制御コマンドを混在できる
4. **The** Script Engine **shall** トークの呼び出し（関数呼び出し）をサポートする
5. **The** Script Engine **shall** UTF-8エンコーディングのスクリプトファイルを読み込める

---

### Requirement 2: 中間表現（IR）出力

**Objective:** 描画エンジンとして、パース済みの構造化データを受け取りたい。それによりTypewriterは表示アニメーションに専念できる。

#### Acceptance Criteria

1. **The** Script Engine **shall** スクリプトを中間表現（IR）に変換して出力できる
2. **The** Script Engine **shall** テキストトークン（表示文字列）をIRに含められる
3. **The** Script Engine **shall** ウェイトトークン（待機時間）をIRに含められる
4. **The** Script Engine **shall** サーフェス切り替えトークンをIRに含められる
5. **The** Script Engine **shall** 発言者切り替えトークンをIRに含められる
6. **The** Script Engine **shall** 将来の拡張トークン（速度変更、ポーズ等）を追加可能な設計とする
7. **The** Script Engine **shall** IRの型定義を `wintf-P0-typewriter` と共有する

---

### Requirement 3: さくらスクリプト互換出力

**Objective:** ゴースト制作者として、既存のさくらスクリプト知識を活用したい。それにより学習コストを削減できる。

#### Acceptance Criteria

1. **The** Script Engine **shall** さくらスクリプトの基本コマンドをIRに変換できる
2. **The** Script Engine **shall** サーフェス切り替えコマンド（`\s[n]`）を解釈できる
3. **The** Script Engine **shall** ウェイトコマンド（`\w[n]}`, `\_w[n]`）を解釈できる
4. **The** Script Engine **shall** 発言者切り替えコマンド（`\0`, `\1`等）を解釈できる
5. **The** Script Engine **shall** 改行コマンド（`\n`）を解釈できる
6. **The** Script Engine **shall** 独自拡張コマンドを定義できる

---

### Requirement 4: 変数管理

**Objective:** ゴースト制作者として、キャラクターの状態を変数で管理したい。それにより動的な会話を実現できる。

#### Acceptance Criteria

1. **The** Script Engine **shall** グローバル変数を保持・参照・更新できる
2. **The** Script Engine **shall** ローカル変数（トーク内スコープ）をサポートする
3. **The** Script Engine **shall** 変数の型（文字列、数値、真偽値）をサポートする
4. **The** Script Engine **shall** 変数を文字列展開（`%(変数名)`等）できる
5. **The** Script Engine **shall** システム変数（日時、カウンター等）を提供する

---

### Requirement 5: 制御構文

**Objective:** ゴースト制作者として、条件分岐やループで複雑なロジックを記述したい。それにより多様な会話パターンを実現できる。

#### Acceptance Criteria

1. **The** Script Engine **shall** 条件分岐（if/else）をサポートする
2. **The** Script Engine **shall** ループ（while/for/repeat）をサポートする
3. **The** Script Engine **shall** 比較演算子（==, !=, <, >, <=, >=）をサポートする
4. **The** Script Engine **shall** 論理演算子（and, or, not）をサポートする
5. **The** Script Engine **shall** 算術演算子（+, -, *, /, %）をサポートする
6. **The** Script Engine **shall** ランダム選択（複数候補から1つを選択）をサポートする

---

### Requirement 6: 複数キャラクター会話制御

**Objective:** ゴースト制作者として、複数キャラクター間の掛け合いを記述したい。それにより漫才的なやりとりを実現できる。

#### Acceptance Criteria

1. **The** Script Engine **shall** 発言者（キャラクター）を切り替えられる
2. **The** Script Engine **shall** 複数キャラクターが同時に発言できる（同期発言）
3. **The** Script Engine **shall** キャラクターが他のキャラクターの発言に割り込めむ
4. **The** Script Engine **shall** キャラクター間でスコープ（変数、状態）を共有できる
5. **The** Script Engine **shall** 2体以上のキャラクター会話をサポートする

---

### Requirement 7: イベントハンドリング

**Objective:** ゴースト制作者として、ユーザーの操作に応じた会話を記述したい。それによりインタラクティブな体験を実現できる。

#### Acceptance Criteria

1. **When** ユーザーがキャラクターをクリックした時, **the** Script Engine **shall** 対応するイベントハンドラを呼び出す
2. **When** ユーザーがキャラクターをダブルクリックした時, **the** Script Engine **shall** 対話イベントを発火する
3. **The** Script Engine **shall** イベント名でハンドラを定義できる
4. **The** Script Engine **shall** イベント引数（クリック位置、キャラクターID等）をハンドラに渡す
5. **The** Script Engine **shall** 未定義イベントのデフォルトハンドラを設定できる

---

## Non-Functional Requirements

### NFR-1: パフォーマンス

1. スクリプト解析は起動時に完了すること
2. イベントハンドラの実行は10ms以内に開始すること
3. メモリ使用量は妥当な範囲に抑えること（スクリプトサイズに比例）

### NFR-2: エラーハンドリング

1. 構文エラーを検出し、エラー位置（行番号）を報告すること
2. ランタイムエラー発生時も可能な限り継続動作すること
3. エラーメッセージは制作者が理解しやすいものであること

### NFR-3: 拡張性

1. 新しいコマンドを追加可能な設計とすること
2. 外部モジュール（MCP等）との連携が可能な設計とすること

---

## Dependencies

### 依存する仕様

| 仕様 | 依存内容 |
|------|----------|
| `wintf-P0-animation-system` | サーフェス切り替えの実行 |
| `wintf-P0-balloon-system` | テキスト表示の実行 |

### 依存される仕様

| 仕様 | 依存内容 |
|------|----------|
| `wintf-P0-typewriter` | **IR（中間表現）の共有**：TypewriterTokenの型定義を共有 |
| `areka-P0-reference-ghost` | スクリプト実行 |
| `areka-P1-devtools` | デバッグ機能 |
| `areka-P2-llm-integration` | LLM応答との統合 |

---

## Glossary

| 用語 | 定義 |
|------|------|
| **DSL** | Domain Specific Language。特定用途向けの言語 |
| **里々** | 伺かゴースト制作用の対話記述言語 |
| **さくらスクリプト** | 伺かの標準スクリプト形式 |
| **トーク** | 1つの発言ブロック（会話単位） |
| **サーフェス** | キャラクターの表情・ポーズ画像 |
| **イベントハンドラ** | 特定のイベントに応じて実行される処理 |
