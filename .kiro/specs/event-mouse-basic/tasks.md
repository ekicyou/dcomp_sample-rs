# Implementation Plan

## タスク概要

| 要件ID | 概要 | タスク |
|--------|------|--------|
| 1 | MouseState コンポーネント | 1.1, 2.2 |
| 2 | MouseLeave マーカー | 2.1, 2.2 |
| 3 | カーソル移動速度 | 1.2 |
| 4 | ローカル座標変換 | 1.3 |
| 5 | Win32 メッセージ統合 | 3.1, 3.2, 3.3, 3.4, 4.1, 4.2 |
| 5A | MouseBuffer | 1.2, 3.1 |
| 6 | WindowMouseTracking | 2.1 |
| 7 | FrameFinalize | 2.2 |

---

## Tasks

- [x] 1. コアデータ型の定義
- [x] 1.1 (P) マウス状態コンポーネントを定義する
  - 座標、ボタン押下状態、修飾キー、ダブルクリック、ホイールなどのフィールドを持つコンポーネントを定義
  - SparseSet ストレージを指定（頻繁な挿入/削除に最適化）
  - 物理ピクセル座標型、ダブルクリック列挙型、ホイールデルタ型、速度型を定義
  - Default トレイトを実装して初期値を提供
  - _Requirements: 1_

- [x] 1.2 (P) マウスバッファ構造体を定義する
  - 位置サンプル（座標 + タイムスタンプ）を保持するリングバッファを実装
  - ボタンごとの押下/解放状態を記録するバッファを実装
  - 最大5サンプルの履歴から速度を計算するメソッドを実装
  - VecDeque による効率的なサンプル管理
  - _Requirements: 3, 5A_

- [x] 1.3 (P) ヒットテスト仮スタブを定義する
  - ウィンドウエンティティを常に返すプレースホルダー関数を実装
  - ローカル座標変換を含む詳細版スタブも実装
  - Phase 2（event-hit-test 完了後）での差し替えを考慮した設計
  - _Requirements: 4_

- [x] 2. Enter/Leave パターンの実装
- [x] 2.1 (P) トラッキング状態管理を実装する
  - マウストラッキング状態を保持するコンポーネントを定義
  - 離脱マーカーコンポーネントを定義（SparseSet ストレージ）
  - ウィンドウ作成時にトラッキングコンポーネントを自動付与
  - _Requirements: 2, 6_

- [x] 2.2 フレーム終了時クリーンアップを実装する
  - 既存スケジュールを FrameFinalize にリネーム
  - 離脱マーカーを全削除するシステムを実装
  - ダブルクリック、ホイール情報をリセットするシステムを実装
  - スケジュール実行順序（Commit後）を確認
  - _Requirements: 1, 2, 7_

- [x] 3. Win32 メッセージハンドラ実装
- [x] 3.1 マウス移動メッセージハンドラを実装する
  - WM_MOUSEMOVE を受信して位置をバッファに蓄積
  - wParam からボタン/修飾キー状態を抽出
  - 初回移動時に TrackMouseEvent(TME_LEAVE) を呼び出し
  - トラッキング状態コンポーネントを更新
  - 借用区切り方式で World アクセス（既存パターン準拠）
  - _Requirements: 5, 5A, 6_

- [x] 3.2 マウスボタンメッセージハンドラを実装する
  - WM_LBUTTONDOWN/UP, WM_RBUTTONDOWN/UP を処理
  - WM_MBUTTONDOWN/UP, WM_XBUTTONDOWN/UP を処理
  - ボタンバッファに押下/解放イベントを記録
  - XButton の識別（GET_XBUTTON_WPARAM）
  - _Requirements: 5_

- [x] 3.3 ダブルクリック・ホイールメッセージハンドラを実装する
  - ウィンドウクラスに CS_DBLCLKS スタイルを追加
  - WM_*DBLCLK メッセージでダブルクリック種別を設定
  - WM_MOUSEWHEEL, WM_MOUSEHWHEEL でホイール回転量を蓄積
  - _Requirements: 5_

- [x] 3.4 マウス離脱メッセージハンドラを実装する
  - WM_MOUSELEAVE を受信して状態コンポーネントを削除
  - 離脱マーカーを付与
  - トラッキング状態を無効化
  - _Requirements: 5, 6_

- [x] 4. 非クライアント領域・バッファ処理
- [x] 4.1 WM_NCHITTEST ハンドラを実装する
  - クライアント領域判定を実装
  - hit_test 仮スタブを呼び出し
  - HTCLIENT / HTTRANSPARENT を返す（クリックスルー対応）
  - 借用失敗時は DefWindowProcW に委譲
  - _Requirements: 5_

- [x] 4.2 マウスバッファ処理システムを実装する
  - Input スケジュールでバッファ内容を状態コンポーネントに反映
  - 速度計算を実行（履歴から算出）
  - ボタン状態の統合（DOWN優先ルール）
  - バッファクリア（履歴は保持）
  - _Requirements: 1, 3, 5A_

- [x] 5. 統合テスト
- [x] 5.1 コンポーネント単体テストを実装する
  - マウスバッファのサンプル蓄積・上限テスト
  - 速度計算の精度テスト
  - ボタンバッファの状態記録テスト
  - _Requirements: 1, 3, 5A_

- [x] 5.2 Enter/Leave 検出テストを実装する
  - Added<MouseState> による Enter 検出
  - With<MouseLeave> による Leave 検出
  - FrameFinalize でのクリーンアップ確認
  - _Requirements: 2, 7_

---

_Generated by AI-DLC System on 2025-12-03_
