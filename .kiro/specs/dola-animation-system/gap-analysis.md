# Dola Animation System — ギャップ分析レポート

> **注意（2026-02-14 追記）**: 本レポートは要件 v1.0 時点で作成。その後の要件改訂（v1.6）により以下の変更がある：
> - 旧 Req 7（プラグインIF）・旧 Req 8（時間管理）はスコープ外に移行（将来の別仕様）
> - 旧 Req 9（クレート構成）→ 現 Req 7 に番号変更
> - 旧 Req 6（オーケストレーション制御）→ 現 Req 6（再生制御データモデル）に変更（ランタイムはスコープ外）
> - 曖昧性分析の多く（A, B, E, F, H, J, N, O, P, Q, R, S, T）は要件改訂で解決済みまたはスコープ外
> - 残存する設計判断事項: C（値域の扱い）, G（型別トランジション制限）, I（KF解決タイミング）, K（サブSB）, L（ループ区間）, M（バージョン互換性ポリシー）

| 項目 | 内容 |
|------|------|
| **対象仕様** | dola-animation-system |
| **分析日** | 2026-02-13 |
| **分析種別** | 新規設計 + 要件明確化 + 依存クレート調査 |

---

## 1. 分析サマリー

- **新規クレート設計**: Dola は wintf 非依存の独立クレートとして新規設計。既存コードベースとの直接的なギャップは少ないが、wintf 既存の `com/animation.rs` (Windows Animation Manager ラッパー) との責務分離が設計上の焦点となる
- **要件の曖昧箇所**: 9件の要件のうち、複数箇所で「何を」「どこまで」が未確定。特にプラグインインターフェースの具体像、文字列型/再生位置型の補間戦略、WAM概念の取捨選択が要検討
- **クレート選定**: `keyframe` が Dola の用途に最も近いが serde 対応がないため、イージング関数のみ借用するか自前実装するかの判断が必要
- **WAM概念の再解釈**: WAM のスケジューリング・優先度・競合解決という高度な概念をどこまで取り込むかが最大の設計判断点

---

## 2. 要件の曖昧性分析

### 2.1 Requirement 1: アニメーション変数 — 曖昧箇所

| # | 曖昧な点 | 影響 | 判断カテゴリ |
|---|----------|------|-------------|
| A | **文字列型変数の「補間」とは何か？** 文字列は連続値ではないため、トランジションの適用方法が不明。離散切り替え専用か？トランジション内で文字列を段階的に変える（タイプライター効果）もスコープ内か？ | データモデル設計に直結 | **要確認** |
| B | **再生位置型の精度と表現** f64秒、フレーム番号(u32/u64)、タイムコード(hh:mm:ss:ff)のいずれを主表現とするか？相互変換は必要か？ | 型設計に直結 | **要確認** |
| C | **値域（上限・下限）の扱い** 変数が値域を超えた場合の挙動が未定義。クランプ？エラー？無視？WAM は下限・上限バウンドを持つがクランプする | デフォルト動作の決定 | **設計判断** |
| D | **変化通知のタイミングと粒度** 毎フレーム？変化があった時のみ？閾値超過時？パフォーマンスに影響 | API設計に直結 | **設計判断** |

### 2.2 Requirement 2: トランジション — 曖昧箇所

| # | 曖昧な点 | 影響 | 判断カテゴリ |
|---|----------|------|-------------|
| E | **WAM のトランジション種別の取捨選択** WAM は accelerate-decelerate, cubic, smooth-stop, sinusoidal, parabolic, reversal 等を提供。Dola でどこまで組み込みサポートするか？ | 実装範囲と複雑性 | **要確認** |
| F | **「カスタムイージング関数を登録」の具体像** シリアライズ不可能なクロージャ/trait object か？ベジェ曲線パラメータとしてシリアライズ可能な形式か？両方か？ | シリアライズ設計に直結 | **要確認** |
| G | **文字列型・再生位置型に対するトランジション適用** 文字列は離散のみ、再生位置は線形のみ？型ごとに適用可能なトランジション種別を制限するか？ | 型システム設計 | **設計判断** |

### 2.3 Requirement 3: キーフレーム — 曖昧箇所

| # | 曖昧な点 | 影響 | 判断カテゴリ |
|---|----------|------|-------------|
| H | **WAM の「コンテキスト依存デュレーション」を取り込むか** WAM では実行時の変数の値/速度に応じてトランジション持続時間が動的に変わる。Dola は宣言的データモデルなので静的定義のみか？ | アーキテクチャの根幹 | **要確認** |
| I | **キーフレームの解決タイミング** シリアライズ時（静的）か、再生開始時（動的）か？トランジション後キーフレームは再生開始しないと位置が確定しない | ランタイム設計 | **設計判断** |

### 2.4 Requirement 4: ストーリーボード — 曖昧箇所

| # | 曖昧な点 | 影響 | 判断カテゴリ |
|---|----------|------|-------------|
| J | **ストーリーボードのスケジューリング・競合解決** WAM の中核機能はストーリーボード間の変数競合解決（Cancel/Trim/Conclude/Compress）。Dola でこれを取り込むか？ | 設計の複雑性に大きく影響 | **要確認** |
| K | **ストーリーボードの入れ子（サブストーリーボード）** 再利用のためにストーリーボードを入れ子にできるか？WAMにはこの概念がない | データモデル設計 | **設計判断** |
| L | **ループの区間指定** ストーリーボード全体のループのみか、一部区間のループ（リピートセクション）もサポートするか？ | データモデル設計 | **設計判断** |

### 2.5 Requirement 5: シリアライズ — 曖昧箇所

| # | 曖昧な点 | 影響 | 判断カテゴリ |
|---|----------|------|-------------|
| M | **スキーマバージョンの互換性ポリシー** マイナーバージョンは後方互換？完全一致のみ？マイグレーション機能は必要か？ | 長期運用設計 | **設計判断** |
| N | **カスタムイージング関数のシリアライズ** ベジェ制御点はシリアライズ可能だが、任意の `fn(f64) -> f64` はシリアライズ不可。「登録済み名前」で参照する方式か？ | Req 2-F と連動 | **要確認（Fと同時に）** |

### 2.6 Requirement 6: オーケストレーション制御 — 曖昧箇所

| # | 曖昧な点 | 影響 | 判断カテゴリ |
|---|----------|------|-------------|
| O | **早期終了時の変数最終値** 即座に終了値にジャンプするか？現在値で停止するか？WAM は Conclude（最終値まで早送り）と Cancel（現在値で停止）を分けている | API設計 | **要確認** |
| P | **複数ストーリーボードの同時再生** 同一変数を複数のストーリーボードが同時にアニメーションしようとした場合の挙動が未定義。Req 4-J と連動 | ランタイム設計 | **要確認（Jと同時に）** |

### 2.7 Requirement 7: プラグインインターフェース — 曖昧箇所

| # | 曖昧な点 | 影響 | 判断カテゴリ |
|---|----------|------|-------------|
| Q | **「プラグイン」の技術的実装形態** Rust trait? コールバック関数? チャネル? ECS System? プラグインが wasm モジュールや別プロセスの可能性はあるか？ | アーキテクチャ全体 | **要確認** |
| R | **プラグインの登録タイミングとライフサイクル** ストーリーボード定義時？再生開始時？動的登録/解除？ | API設計 | **設計判断** |

### 2.8 Requirement 8: 時間管理 — 曖昧箇所

| # | 曖昧な点 | 影響 | 判断カテゴリ |
|---|----------|------|-------------|
| S | **シーク時のイベント発火** シーク先の区間で発生するはずだったイベント（状態変化通知等）をスキップするか？遡って発火するか？ | イベント設計 | **設計判断** |
| T | **逆再生の可否** 時刻を巻き戻すことで逆再生は可能か？WAM は前方向のみ | スコープ判断 | **設計判断** |

### 2.9 Requirement 9: クレート構成 — 曖昧箇所

| # | 曖昧な点 | 影響 | 判断カテゴリ |
|---|----------|------|-------------|
| U | **配置場所** ワークスペース内 `crates/dola/` か？別リポジトリか？サブモジュールか？ | プロジェクト構成 | **要確認** |
| V | **wintf との統合層** Dola 自体は wintf 非依存だが、wintf から Dola を使うための統合層（ブリッジ）はどこに配置するか？ | 依存関係設計 | **設計判断** |

---

## 3. 候補クレート調査

### 3.1 イージング計算クレート比較

| クレート | バージョン | 最終更新 | DL数 | 特徴 | serde対応 | no_std |
|----------|-----------|----------|------|------|-----------|--------|
| **keyframe** | 1.1.1 | 4年前 | 585K | AnimationSequence + EasingFunction trait + ベジェ曲線 + mint統合 + derive マクロ | ❌ | ✅ (optional alloc) |
| **interpolation** | 0.3.0 | 2年前 | 895K | Lerp/Ease trait + EaseFunction enum + ベジェ補間 | ❌ | ❌ |
| **simple-easing** | 1.0.1 | 3年前 | 575K | 純粋なイージング関数のみ（`fn(f32) -> f32`）| N/A | ❌ |
| **ezing** | 0.2.1 | 7年前 | 75K | イージング関数のみ | N/A | ❌ |

### 3.2 クレート評価

#### keyframe（推奨候補A）

**利点:**
- `EasingFunction` trait によるカスタムイージング定義が容易
- `AnimationSequence` が Dola のストーリーボード変数トラック概念に近い
- `CanTween` trait + derive マクロでカスタム型のトゥイーン対応
- `ease(function, from, to, time)` の API が Dola の値補間に直結
- CSS cubic-bezier 対応のベジェ曲線
- no_std 対応（組み込み向けだが依存の軽さの指標）

**懸念:**
- 4年間メンテナンスなし（ただし安定版で機能十分）
- serde 未対応 → `EasingFunction` のシリアライズは自前実装が必要
- `AnimationSequence` は「単一変数の値列」であり、Dola の「複数変数のストーリーボード」とは抽象度が異なる → シーケンス機能は借用せず `ease()` 関数とイージング関数定義のみ利用が現実的

#### interpolation（推奨候補B）

**利点:**
- `EaseFunction` enum（30種類のイージング関数を列挙型で定義）→ serde の `Serialize`/`Deserialize` を **enum に追加すれば** シリアライズ可能
- `Lerp` trait が汎用的
- Piston エコシステム由来で実績あり

**懸念:**
- `EaseFunction` は外部クレートの enum なので、serde derive を付けるには newtype ラッパーか `#[serde(remote)]` が必要
- イージング関数のカスタマイズ性が keyframe より低い（enum 固定）
- 2年間メンテナンスなし

#### simple-easing

**利点:**
- 最もシンプル（純粋関数のみ、依存ゼロ）
- `fn(f32) -> f32` シグネチャで完全に自由に組み込み可能

**懸念:**
- f32 固定（Dola は f64）→ キャスト必要
- 関数のみでフレームワーク機能なし
- カスタムイージングの仕組みなし

### 3.3 推奨アプローチ（設計フェーズへの提案）

**Option A: keyframe をイージング計算に採用**
- `keyframe::ease()` と `keyframe::functions::*` をイージング計算に使用
- `AnimationSequence` は使用せず、Dola 独自のストーリーボード構造を構築
- カスタムイージングは `EasingFunction` trait を実装
- シリアライズは Dola 側で `EasingKind` enum を定義し、名前ベースでマッピング

**Option B: 自前イージング実装 + simple-easing 参考**
- イージング関数を自前で実装（simple-easing のアルゴリズムを f64 で再実装）
- 外部依存ゼロで完全な制御
- serde 対応もネイティブ
- 工数は keyframe 利用と大差なし（イージング関数自体は小さい）

**Option C: interpolation の EaseFunction enum を採用**
- 列挙型ベースでシリアライズとの親和性が最も高い
- キュービックベジェ等のカスタムイージングには追加実装が必要

---

## 4. wintf-P0-animation-system との責務境界

### 現在の既存コード

[crates/wintf/src/com/animation.rs](crates/wintf/src/com/animation.rs) に Windows Animation Manager の COM ラッパーが存在：
- `IUIAnimationTimer` — 時間取得
- `IUIAnimationManager2` — 変数作成・更新・ストーリーボード作成
- `IUIAnimationTransitionLibrary2` — トランジション種別
- `IUIAnimationStoryboard2` — ストーリーボードスケジューリング
- `IUIAnimationVariable2` — 変数値取得・DirectComposition曲線出力

### 責務境界の整理

```
┌─────────────────────────────────────────────┐
│  Dola（本仕様）                              │
│  宣言的データモデル + オーケストレーション     │
│  - ストーリーボード定義（シリアライズ可能）     │
│  - 値補間計算（純Rust、イージング関数）        │
│  - プラグインインターフェース                  │
│  - 時間管理                                   │
│  ※ プラットフォーム非依存                      │
└─────────────────────┬───────────────────────┘
                      │ 値変化通知
┌─────────────────────▼───────────────────────┐
│  wintf 統合層（将来の統合仕様）               │
│  - Dola → wintf ブリッジ                      │
│  - Dola の値変化を ECS コンポーネントに反映    │
│  - DirectComposition プロパティへの適用         │
└─────────────────────┬───────────────────────┘
                      │ COM API
┌─────────────────────▼───────────────────────┐
│  wintf-P0-animation-system                   │
│  - Windows Animation Manager COM ラッパー     │
│  - IDCompositionAnimation 出力                │
│  - GPU アクセラレーション                     │
└─────────────────────────────────────────────┘
```

**注意**: Dola が純Rust値補間を行い、wintf-P0-animation-system が GPU アクセラレーションを提供するという二重構造が存在する。設計フェーズでは「Dola の値補間結果を wintf に渡す」「WAMCOM API をDolaのバックエンドとして使う」のどちらが適切かを判断する必要がある。

---

## 5. 実装複雑性・リスク評価

| 要件 | 工数 | リスク | 根拠 |
|------|------|--------|------|
| Req 1: アニメーション変数 | S | Low | データモデル定義のみ。enum + serde |
| Req 2: トランジション | M | Medium | イージング関数の選定と種別の取捨選択に依存 |
| Req 3: キーフレーム | M | Medium | WAM概念の再解釈度合いで複雑性が変動 |
| Req 4: ストーリーボード | L | High | 複数変数同期、ループ、スケジューリング |
| Req 5: シリアライズ | S | Low | serde derive で大部分対応。カスタムイージングのシリアライズのみ要検討 |
| Req 6: オーケストレーション | M | Medium | 状態管理とイベント通知の設計 |
| Req 7: プラグインIF | M | High | 「プラグイン」の技術的実装形態が未確定 |
| Req 8: 時間管理 | S | Low | 外部時刻供給とtick駆動は単純 |
| Req 9: クレート構成 | S | Low | Cargo workspace 追加のみ |

**総合工数**: L（1-2週間）  
**総合リスク**: Medium-High（プラグインIFと WAM概念取捨選択が不確定）

---

## 6. 設計フェーズへの推奨事項

### 優先的に解決すべき設計判断

1. **WAM 概念の取捨選択** (H, J, O, P): コンテキスト依存デュレーション・ストーリーボード競合解決を取り込むかどうか。取り込まない場合は大幅にシンプルになる
2. **プラグインインターフェースの技術的形態** (Q): trait / callback / channel の選択
3. **カスタムイージングのシリアライズ戦略** (F, N): 名前ベース参照 vs ベジェ制御点 vs 両方
4. **イージング計算クレートの選定** (Req 2-8, Req 9-4): keyframe vs 自前実装 vs interpolation

### Research Needed（設計フェーズで調査）

- `keyframe` クレートの `EasingFunction` trait が serde と共存可能か（trait object のシリアライズ戦略）
- `interpolation` クレートの `EaseFunction` enum に `#[serde(remote)]` を適用する際の制約
- Dola と wintf-P0-animation-system の値補間二重構造の解消方針
