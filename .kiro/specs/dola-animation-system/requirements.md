# Requirements Document

| 項目 | 内容 |
|------|------|
| **Document Title** | Dola アニメーション宣言フォーマット 要件定義書 |
| **Version** | 1.2 |
| **Date** | 2026-02-13 |
| **Status** | Draft |

---

## Introduction

Dola（**D**eclarative **O**rchestration for **L**ive **A**nimation）は、バルーン・シェルなどの任意のプラグインと連携するアニメーションオーケストレーションのための宣言フォーマットである。Windows Animation Manager の概念（ストーリーボード・キーフレーム・トランジション・アニメーション変数）を借用しつつ、シリアライズ可能なプラットフォーム非依存のデータモデルとして再構成する。

### 設計意図

Windows Animation Manager が COM インターフェースを通じて提供するアニメーション構成・スケジューリング・値補間の概念を、シリアライズ可能なデータ形式として再構成する。これにより：

- プラグイン間でアニメーション定義を共有可能にする
- アニメーション定義をファイルとして保存・配布可能にする
- オーケストレーション（制御）とプレイバック（再生）を明確に分離する

### 既存仕様との関係

| 仕様名 | 関係 |
|--------|------|
| `wintf-P0-animation-system` | wintf フレームワーク内部のアニメーション実行基盤。Dola はそれより上位のオーケストレーション層として位置づけられる |
| `wintf-P0-balloon-system` | バルーンプラグインが Dola のプレイバック対象となりうる |
| `areka-P0-reference-shell` | シェルプラグインが Dola のプレイバック対象となりうる |

### スコープ

**本仕様のゴール:**
- シリアライズ可能なアニメーション宣言フォーマットの確定
- 上記フォーマットに対応する Rust 構造体の定義
- 便利なビルダー構造体の提供

**含まれるもの:**
- ストーリーボード・キーフレーム・トランジションのデータモデル定義
- アニメーション変数（f64連続値・i64離散値・Object切り替え）の型定義
- json/toml/yaml へのシリアライズ・デシリアライズ
- イージング関数の列挙型定義（`interpolation` クレートの `EaseFunction` 命名準拠）
- 再生制御に必要なデータ型（状態列挙型・タイムスケール等）の定義

**含まれないもの:**
- オーケストレーションランタイム（再生エンジン・状態遷移ロジック・値補間計算）→ 将来の別仕様
- プラグインプレイバックインターフェース → 将来の別仕様
- 描画処理（各プラグインの責務）
- Windows Animation Manager COM API の直接利用（wintf-P0-animation-system の責務）
- 個別プラグインの実装

---

## Requirements

### Requirement 1: アニメーション変数（AnimationVariable）

**Objective:** プラグイン開発者として、異なる型の値をアニメーション可能な変数として定義したい。それにより連続値・離散値・任意オブジェクトなど多彩な値変化を統一的に扱える。

#### Acceptance Criteria

1. **The** Dola **shall** f64 型の連続値アニメーション変数をサポートする（座標・透明度・角度等の連続的な値変化）
2. **The** Dola **shall** i64 型の離散値アニメーション変数をサポートする（イージング対応。f64 で補間後 i64 に丸める）
3. **The** Dola **shall** Object 型のアニメーション変数をサポートする（文字列・ファイルパス・状態オブジェクト等の JSON 的要素。補間なし、キーフレームで値が切り替わる）
4. **Where** i64 型変数にタイプライター文字列属性が付与されている場合, **the** Dola **shall** 初期値 0・終了値=文字列長としてアニメーションを定義できる（プラグイン側が i64 値を表示文字数として解釈しタイプライター効果を実現）
5. **The** Dola **shall** 各アニメーション変数に一意な名前を付与できる
6. **The** Dola **shall** f64/i64 型アニメーション変数の初期値と値域（上限・下限）を定義できる
7. **The** Dola **shall** Object 型アニメーション変数の初期値を定義できる

---

### Requirement 2: トランジション（Transition）

**Objective:** プラグイン開発者として、アニメーション変数の値がある状態から別の状態へ変化する遷移を定義したい。それにより値の変化方法（線形・イージングなど）を柔軟に制御できる。

#### Acceptance Criteria

1. **The** Dola **shall** 各トランジションに対象のアニメーション変数・終了値・持続時間を指定できる
2. **The** Dola **shall** 線形（linear）トランジションをサポートする（f64/i64 型に適用可能）
3. **The** Dola **shall** `interpolation` クレートの `EaseFunction` 列挙型と同一名称の組み込みイージング関数（全30種: QuadraticIn/Out/InOut, CubicIn/Out/InOut, QuarticIn/Out/InOut, QuinticIn/Out/InOut, SineIn/Out/InOut, CircularIn/Out/InOut, ExponentialIn/Out/InOut, ElasticIn/Out/InOut, BackIn/Out/InOut, BounceIn/Out/InOut）をサポートする（f64/i64 型に適用可能）
4. **The** Dola **shall** 即時（instantaneous）トランジションをサポートする（全型に適用可能）
5. **The** Dola **shall** 定数（constant）トランジション（値を維持して時間を消費する）をサポートする（全型に適用可能）
6. **The** Dola **shall** 二次ベジェ補間（`quad_bez`: 3制御点 x0,x1,x2）をトランジションの値パスとして定義できる（f64/i64 型に適用可能。`interpolation::quad_bez` 準拠）
7. **The** Dola **shall** 三次ベジェ補間（`cub_bez`: 4制御点 x0,x1,x2,x3）をトランジションの値パスとして定義できる（f64/i64 型に適用可能。`interpolation::cub_bez` 準拠）
8. **The** Dola **shall** Object 型にはキーフレーム時点での値切り替え（即時または定数）のみ適用できる
9. **The** Dola **shall** イージング関数・ベジェ補間の列挙型を `interpolation` クレートの命名規則に準拠して自前定義し、`serde` によるシリアライズ・デシリアライズを実装する

---

### Requirement 3: キーフレーム（Keyframe）

**Objective:** プラグイン開発者として、ストーリーボード内の特定の時刻に目印（キーフレーム）を設定したい。それによりトランジションの開始・終了タイミングを柔軟に制御できる。

#### Acceptance Criteria

1. **The** Dola **shall** ストーリーボード開始からのオフセット時間でキーフレームを定義できる
2. **The** Dola **shall** 他のキーフレームからの相対オフセットでキーフレームを定義できる
3. **The** Dola **shall** トランジション終了後の時点をキーフレームとして参照できる
4. **The** Dola **shall** 2つのキーフレーム間にトランジションを配置できる（トランジションの持続時間はキーフレーム間の差分で決定される）
5. **The** Dola **shall** 各キーフレームに一意な名前を付与できる

---

### Requirement 4: ストーリーボード（Storyboard）

**Objective:** プラグイン開発者として、複数のアニメーション変数に対するトランジションを時間軸上に配置したストーリーボードを構成したい。それにより複雑なアニメーションシーケンスを宣言的に定義できる。

#### Acceptance Criteria

1. **The** Dola **shall** 1つのストーリーボードに複数のアニメーション変数へのトランジションを含められる
2. **The** Dola **shall** 同一変数に対する複数のトランジションを時系列順に連結できる
3. **The** Dola **shall** キーフレームを使用してトランジションの開始位置を制御できる
4. **The** Dola **shall** ストーリーボード内のすべてのトランジションを同一タイムライン上に配置し、同期再生可能な形式で定義する
5. **The** Dola **shall** ストーリーボードにループ設定（無限/指定回数）を定義できる
6. **The** Dola **shall** ストーリーボードに一意な名前を付与できる

---

### Requirement 5: シリアライズフォーマット

**Objective:** プラグイン開発者として、ストーリーボード定義を json/toml/yaml ファイルとして保存・読み込みしたい。それによりアニメーション定義をコードと分離して管理・配布できる。

#### Acceptance Criteria

1. **The** Dola **shall** ストーリーボード定義を JSON 形式でシリアライズ・デシリアライズできる
2. **The** Dola **shall** ストーリーボード定義を TOML 形式でシリアライズ・デシリアライズできる
3. **The** Dola **shall** ストーリーボード定義を YAML 形式でシリアライズ・デシリアライズできる
4. **The** Dola **shall** シリアライズ時にスキーマバージョンを含める
5. **If** デシリアライズ時にスキーマバージョンが不一致の場合, **the** Dola **shall** エラーを返す
6. **The** Dola **shall** `serde` を使用してシリアライズ・デシリアライズを実装する
7. **The** Dola **shall** アニメーション変数・トランジション・キーフレーム・ストーリーボードのすべてのデータモデルをシリアライズ可能にする

---

### Requirement 6: 再生制御データモデル

**Objective:** アプリケーション開発者として、ストーリーボードの再生制御に必要なデータ型を宣言的に定義したい。それにより制御状態やタイムスケールをシリアライズ可能な形式で表現できる。

#### Acceptance Criteria

1. **The** Dola **shall** ストーリーボードの再生状態（待機・再生中・一時停止・完了・キャンセル）を表すシリアライズ可能な列挙型を定義する
2. **The** Dola **shall** ストーリーボードにデフォルトのタイムスケール（再生速度倍率、f64、デフォルト 1.0）を設定できる
3. **The** Dola **shall** 時刻を f64 秒で表現する（OS 起動パフォーマンスタイマー基準。f64 は365日連続稼働でも約 7ns の精度を保ち、アニメーション用途に十分）
4. **The** Dola **shall** 再生制御データ型をシリアライズ可能にする

> **将来の別仕様で定義する項目:**
> - オーケストレーションランタイム（再生エンジン・状態遷移ロジック・イベント通知）
> - プラグインプレイバックインターフェース（変数登録・値変化通知・エラーハンドリング）
> - 時間管理ランタイム（外部時刻供給・シーク・値補間計算）

---

### Requirement 7: クレート構成

**Objective:** 開発者として、Dola を独立したクレートとして利用したい。それにより wintf フレームワーク以外のプロジェクトでも再利用できる。

#### Acceptance Criteria

1. **The** Dola **shall** wintf クレートに直接依存しない独立したライブラリクレートとして構成する
2. **The** Dola **shall** `serde` を必須依存とし、シリアライズ機能を提供する
3. **Where** JSON/TOML/YAML の個別フォーマット対応が必要な場合, **the** Dola **shall** Cargo feature フラグで各フォーマットを選択可能にする
4. **The** Dola **shall** 組み込みイージング関数名を `interpolation` クレートの `EaseFunction` 列挙型に準拠させる（ランタイム依存の有無は設計フェーズで判断）
5. **The** Dola **shall** `no_std` 互換性を **要求しない**（Windows デスクトップアプリケーション向け）
