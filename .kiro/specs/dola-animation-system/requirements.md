# Requirements Document

| 項目 | 内容 |
|------|------|
| **Document Title** | Dola アニメーション宣言フォーマット 要件定義書 |
| **Version** | 1.4 |
| **Date** | 2026-02-13 |
| **Status** | Draft |

---

## Introduction

Dola（**D**eclarative **O**rchestration for **L**ive **A**nimation）は、バルーン・シェルなどの任意のプラグインと連携するアニメーションオーケストレーションのための宣言フォーマットである。Windows Animation Manager の概念（ストーリーボード・キーフレーム・トランジション・アニメーション変数）を借用しつつ、シリアライズ可能なプラットフォーム非依存のデータモデルとして再構成する。

### 設計意図

Windows Animation Manager が COM インターフェースを通じて提供するアニメーション構成・スケジューリング・値補間の概念を、シリアライズ可能なデータ形式として再構成する。これにより：

- プラグイン間でアニメーション定義を共有可能にする
- アニメーション定義をファイルとして保存・配布可能にする
- オーケストレーション（制御）とプレイバック（再生）を明確に分離する

### 既存仕様との関係

| 仕様名 | 関係 |
|--------|------|
| `wintf-P0-animation-system` | wintf フレームワーク内部のアニメーション実行基盤。Dola はそれより上位のオーケストレーション層として位置づけられる |
| `wintf-P0-balloon-system` | バルーンプラグインが Dola のプレイバック対象となりうる |
| `areka-P0-reference-shell` | シェルプラグインが Dola のプレイバック対象となりうる |

### スコープ

**本仕様のゴール:**
- シリアライズ可能なアニメーション宣言フォーマットの確定
- 上記フォーマットに対応する Rust 構造体の定義
- 便利なビルダー構造体の提供

**含まれるもの:**
- ストーリーボード・キーフレーム・トランジションのデータモデル定義
- アニメーション変数（f64連続値・i64離散値・Object切り替え）の型定義
- json/toml/yaml へのシリアライズ・デシリアライズ
- イージング関数の列挙型定義（`interpolation` クレートの `EaseFunction` 命名準拠）
- 再生制御に必要なデータ型（状態列挙型・タイムスケール等）の定義

**含まれないもの:**
- オーケストレーションランタイム（再生エンジン・状態遷移ロジック・値補間計算）→ 将来の別仕様
- プラグインプレイバックインターフェース → 将来の別仕様
- 描画処理（各プラグインの責務）
- Windows Animation Manager COM API の直接利用（wintf-P0-animation-system の責務）
- 個別プラグインの実装

---

## Requirements

### Requirement 1: アニメーション変数（AnimationVariable）

**Objective:** プラグイン開発者として、異なる型の値をアニメーション可能な変数として定義したい。それにより連続値・離散値・任意オブジェクトなど多彩な値変化を統一的に扱える。

#### Acceptance Criteria

1. **The** Dola **shall** f64 型の連続値アニメーション変数をサポートする（座標・透明度・角度等の連続的な値変化）
2. **The** Dola **shall** i64 型の離散値アニメーション変数をサポートする（イージング対応。f64 で補間後 i64 に丸める）
3. **The** Dola **shall** Object 型のアニメーション変数をサポートする（文字列・ファイルパス・状態オブジェクト等の JSON 的要素。補間なし、キーフレームで値が切り替わる）
4. **Where** i64 型変数にタイプライター文字列属性が付与されている場合, **the** Dola **shall** 初期値 0・終了値=文字列長としてアニメーションを定義できる（プラグイン側が i64 値を表示文字数として解釈しタイプライター効果を実現）
5. **The** Dola **shall** 各アニメーション変数に一意な名前を付与できる
6. **The** Dola **shall** f64/i64 型アニメーション変数の初期値と値域（上限・下限）を定義できる
7. **The** Dola **shall** Object 型アニメーション変数の初期値を定義できる

---

### Requirement 2: トランジション（Transition）

**Objective:** プラグイン開発者として、アニメーション変数の値がある状態から別の状態へ変化する遷移を定義したい。それにより値の変化方法（線形・イージングなど）を柔軟に制御できる。

#### Acceptance Criteria

1. **The** Dola **shall** トランジションに以下のパラメータを定義できる：
   - `from`（開始値、f64/i64、省略可。省略時は配置時点の変数の現在値）
   - `to`（終了値、f64/i64/Object、`relative_to` と排他）
   - `relative_to`（相対終了値、f64/i64 のみ、開始値からの相対オフセット、`to` と排他）
   - `easing`（イージング種別、線形または30種のイージング関数名、f64/i64 のみ）
   - `delay`（トランジション前の待機時間、f64秒、デフォルト0。値を保持したまま時間を消費）
   - `duration`（遷移の持続時間、f64秒、省略可。省略時は即時遷移）
2. **The** Dola **shall** 線形（`Linear`）イージングをサポートする（f64/i64 型に適用可能）
3. **The** Dola **shall** `interpolation` クレートの `EaseFunction` 列挙型と同一名称の組み込みイージング関数（全30種: QuadraticIn/Out/InOut, CubicIn/Out/InOut, QuarticIn/Out/InOut, QuinticIn/Out/InOut, SineIn/Out/InOut, CircularIn/Out/InOut, ExponentialIn/Out/InOut, ElasticIn/Out/InOut, BackIn/Out/InOut, BounceIn/Out/InOut）をサポートする（f64/i64 型に適用可能）
4. **The** Dola **shall** 二次ベジェ補間（`QuadraticBezier`: 3制御点 x0,x1,x2）をイージング種別として定義できる（f64/i64 型に適用可能。`interpolation::quad_bez` 準拠）
5. **The** Dola **shall** 三次ベジェ補間（`CubicBezier`: 4制御点 x0,x1,x2,x3）をイージング種別として定義できる（f64/i64 型に適用可能。`interpolation::cub_bez` 準拠）
6. **The** Dola **shall** Object 型トランジションには `to` のみ指定可能とし、`from`/`relative_to`/`easing` は適用不可とする（補間不能のため即時切り替えのみ）
7. **The** Dola **shall** イージング関数・ベジェ補間の列挙型を `interpolation` クレートの命名規則に準拠して自前定義し、`serde` によるシリアライズ・デシリアライズを実装する
8. **The** Dola **shall** トランジションに一意な名前を付けて再利用可能なテンプレートとして定義できる（WAM のトランジションは使い捨てだが、宣言フォーマットでは DRY のため名前参照を許可する）
9. **The** Dola **shall** トランジション参照をハイブリッド形式でサポートする：文字列の場合は名前付きテンプレートへの参照、オブジェクトの場合はインライン定義として解釈する
10. **The** Dola **shall** トランジションの総時間は `delay + duration` とする（delay中は値保持、その後duration秒で遷移）

---

### Requirement 3: キーフレーム（Keyframe）

**Objective:** プラグイン開発者として、ストーリーボード内のエントリ配置タイミングを制御するキーフレームを使いたい。それによりトランジションの開始・終了タイミングを柔軟に制御できる。

#### Acceptance Criteria

1. **The** Dola **shall** 各ストーリーボードに予約キーフレーム `"start"` を暗黙的に提供する（ストーリーボード開始時刻 t=0 を表す。WAM の `UI_ANIMATION_KEYFRAME_STORYBOARD_START` 相当）
2. **The** Dola **shall** ストーリーボードエントリに `keyframe` フィールドを付与することで、そのエントリ終了時点を名前付きキーフレームとして登録できる
3. **The** Dola **shall** キーフレーム名のスコープをストーリーボードローカルとする（異なるストーリーボード間でキーフレーム名の衝突は発生しない）
4. **The** Dola **shall** キーフレーム名として `"start"` は予約済みのためユーザー定義不可とする
5. **The** Dola **shall** 同一ストーリーボード内でキーフレーム名の重複を禁止する

---

### Requirement 4: ストーリーボード（Storyboard）

**Objective:** プラグイン開発者として、複数のアニメーション変数に対するトランジションを時間軸上に配置したストーリーボードを構成したい。それにより複雑なアニメーションシーケンスを宣言的に定義できる。

#### Acceptance Criteria

1. **The** Dola **shall** 1つのファイルに複数の名前付きストーリーボードを定義できる
2. **The** Dola **shall** 各ストーリーボードに一意な名前を付与できる
3. **The** Dola **shall** ストーリーボードをエントリ（entry）の配列として構成する（1エントリ = トランジション配置 or キーフレーム定義）
4. **The** Dola **shall** エントリに以下のフィールドを定義できる：
   - `variable`（対象変数名、文字列）
   - `transition`（トランジション参照、名前文字列またはインライン定義オブジェクト）
   - `at`（開始キーフレーム、文字列または `{keyframe, offset}` オブジェクト）
   - `between`（キーフレーム間配置、`{from, to}` オブジェクト。duration はキーフレーム間時間差で上書き）
   - `keyframe`（このエントリ終了時点のキーフレーム名、文字列、任意）
5. **The** Dola **shall** エントリの配置方法として以下の3種類をサポートする：
   - **末尾連結**: `variable` と `transition` のみ指定（`at`/`between` なし）。対象変数のタイムライン末尾に追加（WAM `AddTransition` 相当）
   - **キーフレーム起点**: `at` で開始キーフレームを指定（WAM `AddTransitionAtKeyframe` 相当）
   - **キーフレーム間**: `between` で2つのキーフレームを指定（WAM `AddTransitionBetweenKeyframes` 相当）
6. **The** Dola **shall** `variable` と `transition` を持たないエントリ（純粋なキーフレーム定義エントリ）をサポートする
7. **The** Dola **shall** 各ストーリーボードにメタ情報（ループ設定・タイムスケール等）を定義できる（具体的な配置形式は設計フェーズで決定）
8. **The** Dola **shall** ストーリーボード内のすべてのエントリを同一タイムライン上に配置し、同期再生可能な形式で定義する

---

### Requirement 5: シリアライズフォーマット

**Objective:** プラグイン開発者として、ストーリーボード定義を json/toml/yaml ファイルとして保存・読み込みしたい。それによりアニメーション定義をコードと分離して管理・配布できる。

#### Acceptance Criteria

1. **The** Dola **shall** ストーリーボード定義を JSON 形式でシリアライズ・デシリアライズできる
2. **The** Dola **shall** ストーリーボード定義を TOML 形式でシリアライズ・デシリアライズできる
3. **The** Dola **shall** ストーリーボード定義を YAML 形式でシリアライズ・デシリアライズできる
4. **The** Dola **shall** シリアライズ時にスキーマバージョンを含める
5. **If** デシリアライズ時にスキーマバージョンが不一致の場合, **the** Dola **shall** エラーを返す
6. **The** Dola **shall** `serde` を使用してシリアライズ・デシリアライズを実装する
7. **The** Dola **shall** アニメーション変数・トランジション・キーフレーム・ストーリーボードのすべてのデータモデルをシリアライズ可能にする

---

### Requirement 6: 再生制御データモデル

**Objective:** アプリケーション開発者として、ストーリーボードの再生制御に必要なデータ型を宣言的に定義したい。それにより制御状態やタイムスケールをシリアライズ可能な形式で表現できる。

#### Acceptance Criteria

1. **The** Dola **shall** ストーリーボードの再生状態（待機・再生中・一時停止・完了・キャンセル）を表すシリアライズ可能な列挙型を定義する
2. **The** Dola **shall** ストーリーボードにデフォルトのタイムスケール（再生速度倍率、f64、デフォルト 1.0）を設定できる
3. **The** Dola **shall** フォーマット内のすべての時間値を f64 秒で表現する（相対時間のみ。絶対時刻はランタイムの関心事）
4. **The** Dola **shall** 再生制御データ型をシリアライズ可能にする
5. **The** Dola **shall** ストーリーボード名と開始時刻（f64秒）でスケジューリング指示を表現するデータ型を定義する

> **将来の別仕様で定義する項目:**
> - オーケストレーションランタイム（再生エンジン・状態遷移ロジック・イベント通知）
> - プラグインプレイバックインターフェース（変数登録・値変化通知・エラーハンドリング）
> - 時間管理ランタイム（外部時刻供給・シーク・値補間計算）

---

### Requirement 7: クレート構成

**Objective:** 開発者として、Dola を独立したクレートとして利用したい。それにより wintf フレームワーク以外のプロジェクトでも再利用できる。

#### Acceptance Criteria

1. **The** Dola **shall** wintf クレートに直接依存しない独立したライブラリクレートとして構成する
2. **The** Dola **shall** `serde` を必須依存とし、シリアライズ機能を提供する
3. **Where** JSON/TOML/YAML の個別フォーマット対応が必要な場合, **the** Dola **shall** Cargo feature フラグで各フォーマットを選択可能にする
4. **The** Dola **shall** 組み込みイージング関数名を `interpolation` クレートの `EaseFunction` 列挙型に準拠させる（ランタイム依存の有無は設計フェーズで判断）
5. **The** Dola **shall** `no_std` 互換性を **要求しない**（Windows デスクトップアプリケーション向け）
